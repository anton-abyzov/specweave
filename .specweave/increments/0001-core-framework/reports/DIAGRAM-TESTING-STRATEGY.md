# Diagram Testing Strategy - Closed-Loop Validation

**Document Type**: Testing Strategy
**Created**: 2025-10-26
**Status**: Active
**Scope**: All Mermaid diagrams generated by SpecWeave

---

## Problem Statement

**Observed Issue**: Diagrams generated by `diagrams-architect` agent were not rendering correctly in user projects.

**Root Cause**: Incorrect Mermaid syntax - agent was adding `mermaid` keyword to C4 diagrams (which should start directly with `C4Context`, `C4Container`, `C4Component`).

**Impact**: Users see broken diagrams, lose confidence in framework, must manually fix syntax.

**Violation**: This breaks SpecWeave's **closed-loop validation** principle - diagrams MUST work, not just be created.

---

## Solution: 4-Level Validation Strategy

### Level 1: Syntax Validation (MANDATORY)

**What**: Validate Mermaid syntax before saving diagram

**Implementation**:

1. **C4 Diagrams** (Context, Container, Component):
   - ‚úÖ MUST start with `C4Context`, `C4Container`, or `C4Component`
   - ‚ùå MUST NOT start with `mermaid` keyword
   - ‚úÖ MUST have `title` line (2 spaces indented)
   - ‚úÖ MUST have at least one element (Person, System, Container, Component)
   - ‚úÖ MUST have at least one relationship (Rel)

2. **Standard Diagrams** (Sequence, ER, Class, Flowchart):
   - ‚úÖ MUST start with diagram type keyword: `sequenceDiagram`, `erDiagram`, `classDiagram`, `graph`, `flowchart`
   - ‚úÖ Valid Mermaid syntax (no missing quotes, parentheses, braces)

3. **Common Errors to Check**:
   - ‚ùå Missing quotes in multi-word descriptions: `Person(user, Customer User)` ‚Üí WRONG
   - ‚úÖ Correct: `Person(user, "Customer User", "Buys products")`
   - ‚ùå Missing closing parentheses: `Rel(user, system, "Uses"` ‚Üí WRONG
   - ‚úÖ Correct: `Rel(user, system, "Uses")`
   - ‚ùå Incorrect indentation: `title System Context` ‚Üí WRONG (no indentation)
   - ‚úÖ Correct: `  title System Context` (2 spaces)

**Code Example** (validation pseudocode):

```typescript
function validateMermaidDiagram(content: string): ValidationResult {
  const lines = content.trim().split('\n');
  const firstLine = lines[0].trim();

  // C4 diagrams
  if (firstLine.startsWith('C4Context') ||
      firstLine.startsWith('C4Container') ||
      firstLine.startsWith('C4Component')) {

    // MUST NOT have 'mermaid' keyword before C4
    if (content.includes('mermaid\nC4')) {
      return {
        valid: false,
        error: "C4 diagrams MUST NOT start with 'mermaid' keyword"
      };
    }

    // MUST have title
    if (!content.includes('  title ')) {
      return {
        valid: false,
        error: "C4 diagrams MUST have a title (2 spaces indented)"
      };
    }
  }

  // Standard Mermaid diagrams
  else if (firstLine === 'sequenceDiagram' ||
           firstLine === 'erDiagram' ||
           firstLine === 'classDiagram' ||
           firstLine.startsWith('graph ') ||
           firstLine.startsWith('flowchart ')) {
    // These are correct
  }

  else {
    return {
      valid: false,
      error: `Unknown diagram type. Must start with: C4Context, C4Container, C4Component, sequenceDiagram, erDiagram, classDiagram, graph, or flowchart`
    };
  }

  return { valid: true };
}
```

---

### Level 2: Rendering Test (MANDATORY)

**What**: Verify diagram actually renders in Mermaid viewer

**Implementation**:

1. **After creating diagram**, agent MUST instruct user:
   ```
   ‚úÖ Diagram created: .specweave/docs/internal/architecture/diagrams/system-context.mmd

   üìã VALIDATION REQUIRED:

   1. Open the .mmd file in VS Code
   2. Install Mermaid Preview extension (if not already):
      - VS Code Extension: "Mermaid Preview" by Mermaid.js
   3. Press Cmd+Shift+P (Mac) or Ctrl+Shift+P (Windows)
   4. Type: "Mermaid: Preview Diagram"
   5. Verify diagram renders correctly

   If you see syntax errors:
   - Report the error message immediately
   - Do NOT mark task as complete
   - I will fix the syntax and regenerate
   ```

2. **User feedback loop**:
   - If diagram renders ‚úÖ ‚Üí Mark task complete
   - If diagram fails ‚ùå ‚Üí Fix syntax, regenerate, retest

3. **Agent MUST NOT mark diagram creation as complete** until rendering is verified by user.

---

### Level 3: Test Cases (MANDATORY for agents)

**What**: Agents MUST have ‚â•3 test cases validating diagram generation

**Location**: `src/agents/diagrams-architect/test-cases/`

**Test Coverage**:

| Test Case | Purpose | Validates |
|-----------|---------|-----------|
| test-1-c4-context-diagram.yaml | C4 Level 1 (Context) | ‚úÖ Starts with `C4Context`<br>‚ùå No `mermaid` keyword<br>‚úÖ Has title, actors, systems, relationships |
| test-2-c4-component-diagram.yaml | C4 Level 3 (Component - LLD) | ‚úÖ Starts with `C4Component`<br>‚ùå No `mermaid` keyword<br>‚úÖ Shows internal service structure |
| test-3-sequence-diagram.yaml | Sequence flow | ‚úÖ Starts with `sequenceDiagram`<br>‚úÖ Has participants, calls, responses, notes |

**Test Case Format** (YAML):

```yaml
---
name: "Create C4 Context Diagram"
description: "Tests if diagrams-architect can create a valid C4 Context diagram"

expected_output:
  type: "diagram_created"
  file_location: ".specweave/docs/internal/architecture/diagrams/system-context.mmd"
  diagram_type: "C4Context"
  syntax_valid: true
  mermaid_renderable: true

validation:
  - "Uses C4Context syntax"
  - "DOES NOT start with 'mermaid' keyword (common error)"  # ‚Üê CRITICAL
  - "Starts directly with 'C4Context'"
  - "Has title"
  - "Shows human actors (Person)"
  - "Shows main system (System)"
  - "Has relationships (Rel)"

success_criteria:
  - "File created at correct location"
  - "Valid Mermaid syntax"
  - "Renderable in Mermaid viewer"  # ‚Üê CRITICAL
---
```

---

### Level 4: Automated Integration Tests (P2 Priority)

**What**: Automated tests that validate diagram rendering programmatically

**Implementation** (future):

```typescript
// tests/integration/diagram-rendering.test.ts

import { mermaid } from 'mermaid';
import { readFileSync } from 'fs';

describe('Diagram Rendering Tests', () => {
  test('C4 Context diagram renders without errors', async () => {
    const diagramContent = readFileSync(
      '.specweave/docs/internal/architecture/diagrams/system-context.mmd',
      'utf-8'
    );

    // Attempt to render
    const result = await mermaid.render('test-diagram', diagramContent);

    // Should not throw errors
    expect(result).toBeDefined();
    expect(result.svg).toContain('<svg');
  });

  test('C4 Container diagram renders without errors', async () => {
    const diagramContent = readFileSync(
      '.specweave/docs/internal/architecture/diagrams/system-container.mmd',
      'utf-8'
    );

    const result = await mermaid.render('test-diagram', diagramContent);
    expect(result).toBeDefined();
  });
});
```

**Benefits**:
- Catch syntax errors in CI/CD pipeline
- Prevent broken diagrams from being committed
- Automated regression testing

---

## Diagram Syntax Reference

### C4 Diagrams (NO `mermaid` keyword)

#### C4 Level 1: Context

```
C4Context
  title System Context for E-Commerce Platform

  Person(customer, "Customer", "Buys products")
  System(ecommerce, "E-Commerce Platform", "Handles orders")
  System_Ext(stripe, "Stripe", "Payment processing")

  Rel(customer, ecommerce, "Places orders")
  Rel(ecommerce, stripe, "Processes payments", "HTTPS/REST")
```

#### C4 Level 2: Container

```
C4Container
  title Container Diagram for E-Commerce Platform

  Person(customer, "Customer")

  Container_Boundary(ecommerce, "E-Commerce Platform") {
    Container(web_app, "Web Application", "Next.js, React", "Provides UI")
    Container(api, "API Gateway", "Node.js, Express", "Handles API requests")
    ContainerDb(postgres, "Database", "PostgreSQL", "Stores data")
  }

  Rel(customer, web_app, "Uses", "HTTPS")
  Rel(web_app, api, "API calls", "HTTPS/REST")
```

#### C4 Level 3: Component (LLD)

```
C4Component
  title Component Diagram for Auth Service

  Container_Boundary(auth_service, "Auth Service") {
    Component(controller, "AuthController", "Express Router", "Handles HTTP")
    Component(service, "AuthService", "TypeScript Class", "Business logic")
    ComponentDb(user_db, "User Table", "PostgreSQL", "Stores users")
  }

  Rel(controller, service, "Calls", "TypeScript")
  Rel(service, user_db, "Reads/writes", "SQL")
```

---

### Standard Diagrams (WITH diagram type keyword)

#### Sequence Diagram

```
sequenceDiagram
  participant User
  participant Web
  participant API
  participant Database

  User->>Web: Enter credentials
  Web->>API: POST /api/auth/login
  API->>Database: SELECT * FROM users
  Database-->>API: User record
  API-->>Web: 200 OK {token}
  Web-->>User: Redirect to dashboard
```

#### ER Diagram

```
erDiagram
  USER ||--o{ ORDER : places
  ORDER ||--|{ ORDER_ITEM : contains

  USER {
    uuid id PK
    string email UK
    string password_hash
  }

  ORDER {
    uuid id PK
    uuid user_id FK
    decimal total
  }
```

#### Deployment Diagram (Graph)

```
graph TB
  subgraph "Production"
    LB[Load Balancer]
    APP1[App Server 1]
    APP2[App Server 2]
    DB[(PostgreSQL)]
  end

  Internet[Internet] -->|HTTPS:443| LB
  LB -->|HTTP:3000| APP1
  LB -->|HTTP:3000| APP2
  APP1 --> DB
  APP2 --> DB
```

---

## Agent Workflow (Updated)

### Before Fix

```
1. User: "Create C4 context diagram"
2. Agent: Creates diagram with incorrect syntax (mermaid C4Context...)
3. Agent: Saves to file
4. Agent: ‚úÖ Task complete (WRONG - no validation!)
5. User: Opens file, sees syntax error
6. User: Reports issue
```

**Problem**: No validation, broken diagrams shipped to users.

---

### After Fix (Closed-Loop Validation)

```
1. User: "Create C4 context diagram"
2. Agent: Reads AGENT.md prompt (updated with CRITICAL syntax rules)
3. Agent: Creates diagram with correct syntax (C4Context, no 'mermaid' keyword)
4. Agent: Self-validates syntax:
   - ‚úÖ Starts with C4Context
   - ‚úÖ Has title (2 spaces indented)
   - ‚úÖ Has elements and relationships
   - ‚úÖ No syntax errors
5. Agent: Saves to file
6. Agent: Instructs user to validate rendering
7. User: Opens file in VS Code, enables Mermaid Preview
8. User: ‚úÖ Diagram renders correctly
9. Agent: ‚úÖ Task complete (CORRECT - validated!)
```

**Benefits**: Syntax validated, rendering verified, quality ensured.

---

## Success Metrics

| Metric | Target | Measurement |
|--------|--------|-------------|
| **Syntax Correctness** | 100% | All diagrams pass syntax validation |
| **Rendering Success** | 100% | All diagrams render in Mermaid viewer |
| **User Complaints** | 0 | No syntax error reports from users |
| **Test Coverage** | ‚â•3 tests per agent | diagrams-architect has 3+ test cases |
| **Validation Time** | <30 seconds | User validates rendering in <30s |

---

## Implementation Checklist

### Agent Updates ‚úÖ COMPLETED

- [x] Add CRITICAL syntax rules to `src/agents/diagrams-architect/AGENT.md`
- [x] Add "Common Syntax Errors to Avoid" section
- [x] Add validation checklist (MANDATORY)
- [x] Add rendering test instructions
- [x] Add workflow for creating diagrams
- [x] Update test cases with syntax validation

### Test Case Updates ‚úÖ COMPLETED

- [x] `test-1-c4-context-diagram.yaml` - Add "DOES NOT start with 'mermaid' keyword" validation
- [x] `test-2-c4-component-diagram.yaml` - Add "DOES NOT start with 'mermaid' keyword" validation
- [x] `test-3-sequence-diagram.yaml` - Add "DOES start with 'sequenceDiagram' keyword" validation

### Documentation Updates (In Progress)

- [ ] Update `CLAUDE.md` with diagram validation requirements
- [ ] Add diagram syntax reference to docs
- [ ] Create user guide for validating diagrams

### Future Enhancements (P2)

- [ ] Automated rendering tests (tests/integration/diagram-rendering.test.ts)
- [ ] CI/CD integration (fail build on broken diagrams)
- [ ] Pre-commit hook to validate diagram syntax
- [ ] Mermaid CLI integration for automated validation

---

## Related Documentation

- [src/agents/diagrams-architect/AGENT.md](../../../src/agents/diagrams-architect/AGENT.md) - Complete agent specification
- [CLAUDE.md](../../../CLAUDE.md#c4-diagram-conventions) - C4 diagram conventions
- [TEST-CASE-STRATEGY.md](./TEST-CASE-STRATEGY.md) - Complete test case strategy

---

## Lessons Learned

1. **Closed-loop validation is CRITICAL** - Don't just create, verify it works
2. **Explicit syntax rules prevent errors** - "DO NOT use 'mermaid' keyword" is clearer than examples alone
3. **User feedback loop is essential** - Agent cannot validate rendering without user confirmation
4. **Test cases must validate common errors** - Adding "DOES NOT start with 'mermaid'" catches the bug
5. **Documentation must be comprehensive** - CLAUDE.md, AGENT.md, and test cases must all align

---

**Principle**: **If a diagram doesn't render, it doesn't exist.** Validation is not optional.
