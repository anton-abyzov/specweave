name: Test & Validate

on:
  push:
    branches: [develop, main]
    paths-ignore:
      - 'docs-site/**'
      - '.specweave/docs/public/**'
      - '**.md'
      - '.github/workflows/deploy-docs.yml'
  pull_request:
    branches: [develop, main]
    paths-ignore:
      - 'docs-site/**'
      - '.specweave/docs/public/**'
      - '**.md'
      - '.github/workflows/deploy-docs.yml'

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: [20.x]

    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project (clean build)
        run: npm run rebuild

      - name: Verify build output
        run: |
          # Verify no TypeScript source files in dist/
          if find dist/src -name "*.ts" -not -name "*.d.ts" 2>/dev/null | grep -q .; then
            echo "❌ ERROR: TypeScript source files found in dist/"
            find dist/src -name "*.ts" -not -name "*.d.ts"
            exit 1
          fi
          echo "✅ Build output clean (no .ts source files in dist/)"

      - name: Run tests
        run: npm test

      - name: Run integration tests
        run: npm run test:integration
        env:
          # GitHub token is auto-provided by Actions (no user input here - safe)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Optional: Set to run real integration tests (creates/deletes test data)
          # Note: These are repository secrets, not user-controlled input
          RUN_INTEGRATION_TESTS: 'false'
          AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
          AZURE_DEVOPS_ORG: ${{ secrets.AZURE_DEVOPS_ORG }}
          AZURE_DEVOPS_PROJECT: ${{ secrets.AZURE_DEVOPS_PROJECT }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_DOMAIN: ${{ secrets.JIRA_DOMAIN }}

      - name: Check test coverage
        run: |
          if grep -q '"test:coverage"' package.json; then
            npm run test:coverage
          else
            echo "Test coverage script not configured, skipping"
          fi
        if: matrix.os == 'ubuntu-latest' && matrix.node-version == '20.x'

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        if: matrix.os == 'ubuntu-latest' && matrix.node-version == '20.x'
        with:
          file: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella

  validate-skills:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Check skill tests exist (informational)
        continue-on-error: true
        run: |
          echo "Checking for skill test cases..."
          total_skills=0
          skills_with_tests=0

          # Check skills in all plugins
          for skill in plugins/*/skills/*/; do
            if [ -d "$skill" ]; then
              total_skills=$((total_skills + 1))
              skill_name=$(basename "$skill")

              if [ ! -d "$skill/test-cases" ]; then
                echo "⚠️  Missing test-cases in $skill_name"
              else
                test_count=$(find "$skill/test-cases" -name "*.yaml" 2>/dev/null | wc -l)
                if [ $test_count -lt 3 ]; then
                  echo "⚠️  $skill_name has only $test_count test case(s) (minimum 3 recommended)"
                else
                  echo "✓ $skill_name has $test_count test cases"
                  skills_with_tests=$((skills_with_tests + 1))
                fi
              fi
            fi
          done

          echo ""
          echo "Summary: $skills_with_tests/$total_skills skills have adequate test coverage"
          echo "TODO: Add test cases for remaining skills"

  validate-structure:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Check required directories
        run: |
          required_dirs=("plugins/specweave" "plugins/specweave-github" ".specweave" "src")
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "ERROR: Missing required directory: $dir"
              exit 1
            fi
          done

      - name: Validate CLAUDE.md exists
        run: |
          if [ ! -f "CLAUDE.md" ]; then
            echo "ERROR: CLAUDE.md not found"
            exit 1
          fi

      - name: Check increment structure (if any exist)
        run: |
          if [ -d ".specweave/increments" ]; then
            echo "Validating increment structure (informational only)..."
            echo ""

            has_warnings=false

            for increment in .specweave/increments/[0-9][0-9][0-9][0-9]-*/; do
              if [ -d "$increment" ]; then
                increment_name=$(basename "$increment")
                echo "Checking: $increment_name"

                # Check if metadata.json exists to determine increment state
                if [ -f "$increment/metadata.json" ]; then
                  # Extract status from metadata.json (requires jq)
                  if command -v jq >/dev/null 2>&1; then
                    status=$(jq -r '.status // "unknown"' "$increment/metadata.json" 2>/dev/null || echo "unknown")
                  else
                    # Fallback: extract status using grep/sed if jq not available
                    status=$(grep -o '"status"[[:space:]]*:[[:space:]]*"[^"]*"' "$increment/metadata.json" 2>/dev/null | sed 's/.*"\([^"]*\)".*/\1/' || echo "unknown")
                  fi

                  echo "  Status: $status"

                  # Check for standard structure (informational)
                  # Only warn - don't fail the build as increments may be:
                  # - Just created (no spec yet)
                  # - Abandoned (incomplete by design)
                  # - Experimental (non-standard structure)
                  # - Completed with alternative structure
                  if [ ! -f "$increment/spec.md" ]; then
                    if [ "$status" = "active" ]; then
                      echo "  ⚠️  Active increment missing spec.md (may need planning)"
                      has_warnings=true
                    else
                      echo "  ℹ️  No spec.md (OK for $status increments)"
                    fi
                  else
                    echo "  ✓ Has spec.md"
                  fi
                else
                  # No metadata.json - could be legacy or in-progress setup
                  echo "  ⚠️  No metadata.json (legacy or incomplete increment)"
                  has_warnings=true
                  if [ ! -f "$increment/spec.md" ]; then
                    echo "  ⚠️  Also missing spec.md"
                  fi
                fi
                echo ""
              fi
            done

            if [ "$has_warnings" = true ]; then
              echo "⚠️  Some increments have warnings but build continues"
              echo "Note: Warnings don't fail the build - increments may be incomplete by design"
            else
              echo "✅ All increments have valid structure"
            fi
          else
            echo "No increments directory found (OK for new projects)"
          fi

  test-structure:
    name: Validate Test Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Check for flat test structure
        run: |
          echo "Checking for flat test structure in tests/integration/..."
          FLAT_DIRS=$(find tests/integration -maxdepth 1 -type d \
            ! -name "integration" \
            ! -name "core" \
            ! -name "features" \
            ! -name "external-tools" \
            ! -name "generators" \
            ! -name "commands" \
            ! -name "deduplication" 2>/dev/null | wc -l)

          if [ "$FLAT_DIRS" -gt 0 ]; then
            echo "❌ ERROR: Flat test structure detected!"
            echo "Found $FLAT_DIRS unauthorized directories."
            echo "Tests must be in: core/, features/, external-tools/, or generators/"
            find tests/integration -maxdepth 1 -type d \
              ! -name "integration" \
              ! -name "core" \
              ! -name "features" \
              ! -name "external-tools" \
              ! -name "generators" \
              ! -name "commands" \
              ! -name "deduplication"
            exit 1
          fi
          echo "✅ Test structure is categorized (no flat directories)"

      - name: Check for unsafe process.cwd() patterns
        run: |
          echo "Checking for unsafe process.cwd() usage in tests..."
          if grep -r "process\.cwd()" tests/ --include="*.test.ts" 2>/dev/null | grep -q .; then
            echo "❌ ERROR: process.cwd() found in tests!"
            echo "This can cause catastrophic .specweave/ deletion."
            echo "Use createIsolatedTestDir() instead. See CLAUDE.md"
            echo ""
            echo "Violations:"
            grep -rn "process\.cwd()" tests/ --include="*.test.ts" | head -20
            exit 1
          fi
          echo "✅ No unsafe process.cwd() patterns"

      - name: Check E2E naming convention
        run: |
          echo "Checking E2E test naming convention..."
          if find tests/e2e -name "*.spec.ts" 2>/dev/null | grep -q .; then
            echo "❌ ERROR: .spec.ts files found in E2E tests!"
            echo "All E2E tests must use .test.ts extension."
            echo ""
            echo "Violations:"
            find tests/e2e -name "*.spec.ts"
            exit 1
          fi
          echo "✅ All E2E tests use .test.ts naming"

      - name: Verify test isolation utilities exist
        run: |
          if [ ! -f "tests/test-utils/isolated-test-dir.ts" ]; then
            echo "❌ ERROR: Test isolation utilities missing!"
            echo "Required: tests/test-utils/isolated-test-dir.ts"
            exit 1
          fi
          echo "✅ Test isolation utilities present"

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Run ESLint (if configured)
        run: |
          if grep -q '"lint"' package.json; then
            npm run lint
          else
            echo "Lint script not configured, skipping"
          fi

      - name: Check markdown formatting (if configured)
        run: |
          if grep -q '"lint:md"' package.json; then
            npm run lint:md
          else
            echo "Markdown lint script not configured, skipping"
          fi
