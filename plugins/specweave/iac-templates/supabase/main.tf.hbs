# Supabase with PostgreSQL, Auth, Storage, and Edge Functions
# Generated by SpecWeave Serverless Intelligence
# Platform: Supabase
# Project: {{projectName}}
# Environment: {{environment}}

terraform {
  required_version = ">= 1.0"
  required_providers {
    supabase = {
      source  = "supabase/supabase"
      version = "~> 1.0"
    }
    {{#if selfHosted}}
    docker = {
      source  = "kreuzwerker/docker"
      version = "~> 3.0"
    }
    {{/if}}
  }
}

{{#unless selfHosted}}
###############################
# Supabase Cloud Project
###############################

resource "supabase_project" "{{snakeCase projectName}}" {
  organization_id   = var.organization_id
  name              = "{{projectName}}-{{environment}}"
  database_password = var.database_password
  region            = var.region

  {{#if (eq environment "prod")}}
  # Production settings
  plan = "pro"
  {{else}}
  # Development/Staging settings
  plan = "free"
  {{/if}}
}

###############################
# Database Configuration
###############################

# Database URL is automatically generated by Supabase
# Access via: supabase_project.{{snakeCase projectName}}.database.host

# Enable required extensions
resource "supabase_settings" "{{snakeCase projectName}}_db" {
  project_ref = supabase_project.{{snakeCase projectName}}.id

  database = {
    extensions = [
      "uuid-ossp",
      "pgcrypto",
      {{#if enablePostgis}}"postgis",{{/if}}
      {{#if enableVectors}}"vector",{{/if}}
    ]
  }
}

{{#if databaseName}}
# SQL Migration for initial schema
resource "supabase_migration" "{{snakeCase databaseName}}_schema" {
  project_ref = supabase_project.{{snakeCase projectName}}.id
  version     = "20240101000000"
  name        = "initial_schema"

  statements = [
    <<-SQL
      -- Create items table
      CREATE TABLE IF NOT EXISTS items (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
        title TEXT NOT NULL,
        description TEXT,
        status TEXT DEFAULT 'active',
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
      );

      -- Enable Row Level Security
      ALTER TABLE items ENABLE ROW LEVEL SECURITY;

      -- Create RLS policies
      CREATE POLICY "Users can view their own items"
        ON items FOR SELECT
        USING (auth.uid() = user_id);

      CREATE POLICY "Users can insert their own items"
        ON items FOR INSERT
        WITH CHECK (auth.uid() = user_id);

      CREATE POLICY "Users can update their own items"
        ON items FOR UPDATE
        USING (auth.uid() = user_id);

      CREATE POLICY "Users can delete their own items"
        ON items FOR DELETE
        USING (auth.uid() = user_id);

      -- Create indexes
      CREATE INDEX IF NOT EXISTS items_user_id_idx ON items(user_id);
      CREATE INDEX IF NOT EXISTS items_status_idx ON items(status);
      CREATE INDEX IF NOT EXISTS items_created_at_idx ON items(created_at DESC);

      -- Create updated_at trigger
      CREATE OR REPLACE FUNCTION update_updated_at_column()
      RETURNS TRIGGER AS $$
      BEGIN
        NEW.updated_at = NOW();
        RETURN NEW;
      END;
      $$ language 'plpgsql';

      CREATE TRIGGER update_items_updated_at
        BEFORE UPDATE ON items
        FOR EACH ROW
        EXECUTE FUNCTION update_updated_at_column();
    SQL
  ]
}
{{/if}}

###############################
# Authentication Configuration
###############################

resource "supabase_settings" "{{snakeCase projectName}}_auth" {
  project_ref = supabase_project.{{snakeCase projectName}}.id

  auth = {
    site_url = {{#if (eq environment "prod")}}"https://{{projectName}}.com"{{else}}"http://localhost:3000"{{/if}}

    external_email_enabled     = true
    external_phone_enabled     = false
    email_confirm_required     = {{#if (eq environment "prod")}}true{{else}}false{{/if}}
    enable_signup              = true
    double_confirm_changes_enabled = {{#if (eq environment "prod")}}true{{else}}false{{/if}}

    # JWT settings
    jwt_expiry = {{#if (eq environment "prod")}}3600{{else}}86400{{/if}}

    # Password settings
    password_min_length = {{#if (eq environment "prod")}}12{{else}}8{{/if}}

    {{#if enableOAuth}}
    # OAuth providers (configure secrets separately)
    external_google_enabled = true
    external_github_enabled = true
    {{/if}}
  }
}

###############################
# Storage Buckets
###############################

resource "supabase_bucket" "{{snakeCase projectName}}_public" {
  project_ref = supabase_project.{{snakeCase projectName}}.id
  name        = "public"
  public      = true
  file_size_limit = {{#if (eq environment "prod")}}10485760{{else}}52428800{{/if}} # {{#if (eq environment "prod")}}10MB{{else}}50MB{{/if}}
  allowed_mime_types = [
    "image/jpeg",
    "image/png",
    "image/gif",
    "image/webp",
    "application/pdf"
  ]
}

resource "supabase_bucket" "{{snakeCase projectName}}_private" {
  project_ref = supabase_project.{{snakeCase projectName}}.id
  name        = "private"
  public      = false
  file_size_limit = {{#if (eq environment "prod")}}10485760{{else}}52428800{{/if}}
  allowed_mime_types = [
    "image/jpeg",
    "image/png",
    "application/pdf",
    "application/json"
  ]
}

# Storage policies
resource "supabase_storage_policy" "{{snakeCase projectName}}_private_read" {
  project_ref = supabase_project.{{snakeCase projectName}}.id
  bucket_name = supabase_bucket.{{snakeCase projectName}}_private.name
  name        = "Users can read their own files"
  operation   = "SELECT"
  definition  = "(bucket_id = 'private' AND auth.uid()::text = (storage.foldername(name))[1])"
}

resource "supabase_storage_policy" "{{snakeCase projectName}}_private_write" {
  project_ref = supabase_project.{{snakeCase projectName}}.id
  bucket_name = supabase_bucket.{{snakeCase projectName}}_private.name
  name        = "Users can upload to their own folder"
  operation   = "INSERT"
  definition  = "(bucket_id = 'private' AND auth.uid()::text = (storage.foldername(name))[1])"
}

###############################
# Edge Functions (Deno)
###############################

# Edge Functions are deployed via Supabase CLI
# supabase functions deploy {{functionName}}

# Example function configuration
resource "supabase_function" "{{snakeCase functionName}}" {
  project_ref = supabase_project.{{snakeCase projectName}}.id
  name        = "{{functionName}}"
  verify_jwt  = true

  # Deploy source code via CLI
  # Source: supabase/functions/{{functionName}}/index.ts
}

###############################
# API Configuration
###############################

resource "supabase_settings" "{{snakeCase projectName}}_api" {
  project_ref = supabase_project.{{snakeCase projectName}}.id

  api = {
    max_rows = {{#if (eq environment "prod")}}1000{{else}}100000{{/if}}
    extra_search_path = "public,extensions"
  }
}

{{else}}
###############################
# Self-Hosted Supabase (Docker)
###############################

# Docker network
resource "docker_network" "supabase" {
  name = "supabase-{{environment}}"
}

# PostgreSQL
resource "docker_container" "postgres" {
  name  = "supabase-db-{{environment}}"
  image = "supabase/postgres:15.1.0.117"

  networks_advanced {
    name = docker_network.supabase.name
  }

  ports {
    internal = 5432
    external = {{#if (eq environment "prod")}}5432{{else}}54322{{/if}}
  }

  env = [
    "POSTGRES_PASSWORD=${var.database_password}",
    "POSTGRES_DB=postgres",
  ]

  volumes {
    container_path = "/var/lib/postgresql/data"
    host_path      = "${var.data_path}/db"
  }

  restart = "unless-stopped"
}

# Supabase Studio (Admin UI)
resource "docker_container" "studio" {
  name  = "supabase-studio-{{environment}}"
  image = "supabase/studio:latest"

  networks_advanced {
    name = docker_network.supabase.name
  }

  ports {
    internal = 3000
    external = {{#if (eq environment "prod")}}3000{{else}}54323{{/if}}
  }

  env = [
    "SUPABASE_URL=http://kong:8000",
    "STUDIO_PG_META_URL=http://meta:8080",
  ]

  restart = "unless-stopped"
}

# Kong API Gateway
resource "docker_container" "kong" {
  name  = "supabase-kong-{{environment}}"
  image = "supabase/kong:latest"

  networks_advanced {
    name = docker_network.supabase.name
  }

  ports {
    internal = 8000
    external = {{#if (eq environment "prod")}}8000{{else}}54321{{/if}}
  }

  restart = "unless-stopped"
}
{{/unless}}
