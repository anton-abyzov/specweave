# GCP Cloud Functions Gen2 with Firestore and Cloud Storage
# Generated by SpecWeave Serverless Intelligence
# Platform: GCP Cloud Functions
# Project: {{projectName}}
# Environment: {{environment}}

terraform {
  required_version = ">= 1.0"
  required_providers {
    google = {
      source  = "hashicorp/google"
      version = "~> 5.0"
    }
  }
}

###############################
# Cloud Storage Bucket for Function Code
###############################

resource "google_storage_bucket" "{{snakeCase functionName}}_source" {
  name          = "{{kebabCase projectName}}-{{functionName}}-source-{{environment}}"
  location      = var.region
  force_destroy = {{#if (eq environment "prod")}}false{{else}}true{{/if}}

  uniform_bucket_level_access = true

  versioning {
    enabled = {{#if (eq environment "prod")}}true{{else}}false{{/if}}
  }

  {{#if (eq environment "prod")}}
  lifecycle_rule {
    condition {
      num_newer_versions = 3
    }
    action {
      type = "Delete"
    }
  }
  {{/if}}

  labels = {
    environment = var.environment
    project     = var.project_name
    managed_by  = "terraform"
  }
}

###############################
# Service Account for Cloud Function
###############################

resource "google_service_account" "{{snakeCase functionName}}" {
  account_id   = "{{kebabCase functionName}}-{{environment}}"
  display_name = "Service Account for {{functionName}} ({{environment}})"
  description  = "Managed by Terraform - Least privilege access for Cloud Function"
}

###############################
# Cloud Function Gen2
###############################

resource "google_cloudfunctions2_function" "{{snakeCase functionName}}" {
  name        = "{{functionName}}-{{environment}}"
  location    = var.region
  description = "{{functionName}} - {{environment}} environment"

  build_config {
    runtime     = "{{#if runtime}}{{runtime}}{{else}}nodejs20{{/if}}"
    entry_point = "{{#if entryPoint}}{{entryPoint}}{{else}}handler{{/if}}"

    source {
      storage_source {
        bucket = google_storage_bucket.{{snakeCase functionName}}_source.name
        object = "{{functionName}}.zip"
      }
    }
  }

  service_config {
    max_instance_count = {{#if (eq environment "prod")}}100{{else if (eq environment "staging")}}10{{else}}5{{/if}}
    min_instance_count = {{#if (eq environment "prod")}}1{{else}}0{{/if}}
    available_memory   = "{{#if memory}}{{memory}}{{else}}256M{{/if}}"
    timeout_seconds    = {{#if timeout}}{{timeout}}{{else}}60{{/if}}

    service_account_email = google_service_account.{{snakeCase functionName}}.email

    environment_variables = {
      ENVIRONMENT = var.environment
      {{#if databaseName}}
      FIRESTORE_PROJECT = var.project_id
      FIRESTORE_DATABASE = google_firestore_database.{{snakeCase databaseName}}.name
      {{/if}}
    }

    {{#if (eq environment "prod")}}
    # VPC Connector for private networking (production)
    # vpc_connector = google_vpc_access_connector.connector.id
    {{/if}}

    ingress_settings = {{#if (eq environment "prod")}}"ALLOW_INTERNAL_AND_GCLB"{{else}}"ALLOW_ALL"{{/if}}
  }

  labels = {
    environment = var.environment
    project     = var.project_name
    managed_by  = "terraform"
  }
}

# Make function publicly accessible (adjust for production)
resource "google_cloudfunctions2_function_iam_member" "{{snakeCase functionName}}_invoker" {
  project        = google_cloudfunctions2_function.{{snakeCase functionName}}.project
  location       = google_cloudfunctions2_function.{{snakeCase functionName}}.location
  cloud_function = google_cloudfunctions2_function.{{snakeCase functionName}}.name

  role   = "roles/cloudfunctions.invoker"
  member = {{#if (eq environment "prod")}}"serviceAccount:${google_service_account.{{snakeCase functionName}}.email}"{{else}}"allUsers"{{/if}}
}

###############################
# Cloud Logging
###############################

resource "google_logging_project_sink" "{{snakeCase functionName}}_logs" {
  name        = "{{kebabCase functionName}}-logs-{{environment}}"
  destination = "storage.googleapis.com/${google_storage_bucket.{{snakeCase functionName}}_logs.name}"

  filter = "resource.type = cloud_function AND resource.labels.function_name = \"{{functionName}}-{{environment}}\""

  unique_writer_identity = true
}

resource "google_storage_bucket" "{{snakeCase functionName}}_logs" {
  name          = "{{kebabCase projectName}}-{{functionName}}-logs-{{environment}}"
  location      = var.region
  force_destroy = {{#if (eq environment "prod")}}false{{else}}true{{/if}}

  uniform_bucket_level_access = true

  lifecycle_rule {
    condition {
      age = {{#if (eq environment "prod")}}90{{else}}30{{/if}}
    }
    action {
      type = "Delete"
    }
  }

  labels = {
    environment = var.environment
    project     = var.project_name
    managed_by  = "terraform"
  }
}

# Grant log writer permissions
resource "google_storage_bucket_iam_member" "log_writer" {
  bucket = google_storage_bucket.{{snakeCase functionName}}_logs.name
  role   = "roles/storage.objectCreator"
  member = google_logging_project_sink.{{snakeCase functionName}}_logs.writer_identity
}

{{#if databaseName}}
###############################
# Firestore Database
###############################

resource "google_firestore_database" "{{snakeCase databaseName}}" {
  project     = var.project_id
  name        = "{{databaseName}}-{{environment}}"
  location_id = var.firestore_location

  # Database type
  type = "FIRESTORE_NATIVE"

  # Concurrency mode
  concurrency_mode = {{#if (eq environment "prod")}}"OPTIMISTIC"{{else}}"PESSIMISTIC"{{/if}}

  # App Engine integration
  app_engine_integration_mode = "DISABLED"

  {{#if (eq environment "prod")}}
  # Point-in-time recovery for production
  point_in_time_recovery_enablement = "POINT_IN_TIME_RECOVERY_ENABLED"
  {{/if}}

  {{#if (eq environment "prod")}}
  # Delete protection for production
  delete_protection_state = "DELETE_PROTECTION_ENABLED"
  {{/if}}
}

# Example Firestore index
resource "google_firestore_index" "{{snakeCase databaseName}}_items" {
  project    = var.project_id
  database   = google_firestore_database.{{snakeCase databaseName}}.name
  collection = "items"

  fields {
    field_path = "createdAt"
    order      = "DESCENDING"
  }

  fields {
    field_path = "status"
    order      = "ASCENDING"
  }
}
{{/if}}
