# Azure Functions with Cosmos DB and Storage
# Generated by SpecWeave Serverless Intelligence
# Platform: Azure Functions
# Project: {{projectName}}
# Environment: {{environment}}

terraform {
  required_version = ">= 1.0"
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 3.0"
    }
  }
}

###############################
# Resource Group
###############################

resource "azurerm_resource_group" "{{snakeCase projectName}}" {
  name     = "rg-{{kebabCase projectName}}-{{environment}}"
  location = var.location

  tags = {
    Name        = "{{projectName}}-{{environment}}"
    Environment = var.environment
    Project     = var.project_name
    ManagedBy   = "Terraform"
  }
}

###############################
# Storage Account
###############################

resource "azurerm_storage_account" "{{snakeCase functionName}}" {
  name                     = "{{snakeCase projectName}}{{environment}}"
  resource_group_name      = azurerm_resource_group.{{snakeCase projectName}}.name
  location                 = azurerm_resource_group.{{snakeCase projectName}}.location
  account_tier             = "Standard"
  account_replication_type = {{#if (eq environment "prod")}}"GRS"{{else}}"LRS"{{/if}}
  min_tls_version          = "TLS1_2"

  # HTTPS only enforcement
  enable_https_traffic_only = true

  # Blob properties
  blob_properties {
    versioning_enabled = {{#if (eq environment "prod")}}true{{else}}false{{/if}}
    delete_retention_policy {
      days = {{#if (eq environment "prod")}}30{{else}}7{{/if}}
    }
  }

  tags = {
    Name        = "{{functionName}}-storage"
    Environment = var.environment
    Project     = var.project_name
  }
}

resource "azurerm_storage_container" "deployments" {
  name                  = "function-deployments"
  storage_account_name  = azurerm_storage_account.{{snakeCase functionName}}.name
  container_access_type = "private"
}

###############################
# Service Plan
###############################

resource "azurerm_service_plan" "{{snakeCase functionName}}" {
  name                = "asp-{{kebabCase functionName}}-{{environment}}"
  resource_group_name = azurerm_resource_group.{{snakeCase projectName}}.name
  location            = azurerm_resource_group.{{snakeCase projectName}}.location
  os_type             = "Linux"

  # Consumption for dev, Premium for prod
  sku_name = {{#if (eq environment "prod")}}"EP1"{{else if (eq environment "staging")}}"B1"{{else}}"Y1"{{/if}}

  tags = {
    Name        = "{{functionName}}-plan"
    Environment = var.environment
    Project     = var.project_name
  }
}

###############################
# Application Insights
###############################

resource "azurerm_application_insights" "{{snakeCase functionName}}" {
  name                = "appi-{{kebabCase functionName}}-{{environment}}"
  resource_group_name = azurerm_resource_group.{{snakeCase projectName}}.name
  location            = azurerm_resource_group.{{snakeCase projectName}}.location
  application_type    = "web"
  retention_in_days   = {{#if (eq environment "prod")}}90{{else}}30{{/if}}

  tags = {
    Name        = "{{functionName}}-insights"
    Environment = var.environment
    Project     = var.project_name
  }
}

###############################
# Function App
###############################

resource "azurerm_linux_function_app" "{{snakeCase functionName}}" {
  name                       = "func-{{kebabCase functionName}}-{{environment}}"
  resource_group_name        = azurerm_resource_group.{{snakeCase projectName}}.name
  location                   = azurerm_resource_group.{{snakeCase projectName}}.location
  service_plan_id            = azurerm_service_plan.{{snakeCase functionName}}.id
  storage_account_name       = azurerm_storage_account.{{snakeCase functionName}}.name
  storage_account_access_key = azurerm_storage_account.{{snakeCase functionName}}.primary_access_key

  # HTTPS only
  https_only = true

  # Managed Identity
  identity {
    type = "SystemAssigned"
  }

  site_config {
    application_stack {
      {{#if (eq runtime "node")}}
      node_version = "{{#if nodeVersion}}{{nodeVersion}}{{else}}18{{/if}}"
      {{else if (eq runtime "python")}}
      python_version = "{{#if pythonVersion}}{{pythonVersion}}{{else}}3.11{{/if}}"
      {{else if (eq runtime "dotnet")}}
      dotnet_version = "{{#if dotnetVersion}}{{dotnetVersion}}{{else}}7.0{{/if}}"
      {{else}}
      node_version = "18"
      {{/if}}
    }

    # CORS configuration
    cors {
      allowed_origins = {{#if (eq environment "prod")}}["https://{{projectName}}.com"]{{else}}["*"]{{/if}}
    }

    # Always On for non-consumption plans
    {{#if (eq environment "prod")}}
    always_on = true
    {{/if}}

    application_insights_connection_string = azurerm_application_insights.{{snakeCase functionName}}.connection_string
    application_insights_key              = azurerm_application_insights.{{snakeCase functionName}}.instrumentation_key
  }

  app_settings = {
    "ENVIRONMENT" = var.environment
    {{#if databaseName}}
    "COSMOSDB_ENDPOINT" = azurerm_cosmosdb_account.{{snakeCase databaseName}}.endpoint
    "COSMOSDB_DATABASE" = azurerm_cosmosdb_sql_database.{{snakeCase databaseName}}.name
    {{/if}}
    "FUNCTIONS_WORKER_RUNTIME" = "{{#if runtime}}{{runtime}}{{else}}node{{/if}}"
    "WEBSITE_RUN_FROM_PACKAGE" = "1"
  }

  tags = {
    Name        = "{{functionName}}-{{environment}}"
    Environment = var.environment
    Project     = var.project_name
    ManagedBy   = "Terraform"
  }
}

{{#if databaseName}}
###############################
# Cosmos DB
###############################

resource "azurerm_cosmosdb_account" "{{snakeCase databaseName}}" {
  name                = "cosmos-{{kebabCase databaseName}}-{{environment}}"
  resource_group_name = azurerm_resource_group.{{snakeCase projectName}}.name
  location            = azurerm_resource_group.{{snakeCase projectName}}.location
  offer_type          = "Standard"
  kind                = "GlobalDocumentDB"

  # Consistency
  consistency_policy {
    consistency_level = {{#if (eq environment "prod")}}"Session"{{else}}"Eventual"{{/if}}
  }

  # Geo-replication
  geo_location {
    location          = azurerm_resource_group.{{snakeCase projectName}}.location
    failover_priority = 0
  }

  {{#if (eq environment "prod")}}
  # Secondary region for production
  geo_location {
    location          = var.secondary_location
    failover_priority = 1
  }
  {{/if}}

  # Backup
  backup {
    type                = {{#if (eq environment "prod")}}"Continuous"{{else}}"Periodic"{{/if}}
    {{#unless (eq environment "prod")}}
    interval_in_minutes = 240
    retention_in_hours  = 8
    {{/unless}}
  }

  tags = {
    Name        = "{{databaseName}}-{{environment}}"
    Environment = var.environment
    Project     = var.project_name
  }
}

resource "azurerm_cosmosdb_sql_database" "{{snakeCase databaseName}}" {
  name                = "{{databaseName}}"
  resource_group_name = azurerm_cosmosdb_account.{{snakeCase databaseName}}.resource_group_name
  account_name        = azurerm_cosmosdb_account.{{snakeCase databaseName}}.name

  # Serverless for dev, provisioned for prod
  {{#if (eq environment "prod")}}
  throughput = 400
  {{else}}
  # Serverless (pay-per-request)
  {{/if}}
}

resource "azurerm_cosmosdb_sql_container" "{{snakeCase databaseName}}" {
  name                = "items"
  resource_group_name = azurerm_cosmosdb_account.{{snakeCase databaseName}}.resource_group_name
  account_name        = azurerm_cosmosdb_account.{{snakeCase databaseName}}.name
  database_name       = azurerm_cosmosdb_sql_database.{{snakeCase databaseName}}.name
  partition_key_path  = "/id"

  indexing_policy {
    indexing_mode = "consistent"

    included_path {
      path = "/*"
    }
  }
}
{{/if}}
