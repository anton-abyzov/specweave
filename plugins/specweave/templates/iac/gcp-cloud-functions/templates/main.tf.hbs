# GCP Cloud Functions (2nd gen) + Firestore + Cloud Run Terraform Configuration
# Generated by SpecWeave Serverless Architecture Intelligence

# Enable required APIs
resource "google_project_service" "cloudfunctions" {
  service            = "cloudfunctions.googleapis.com"
  disable_on_destroy = false
}

resource "google_project_service" "run" {
  service            = "run.googleapis.com"
  disable_on_destroy = false
}

resource "google_project_service" "firestore" {
  service            = "firestore.googleapis.com"
  disable_on_destroy = false
}

resource "google_project_service" "cloudbuild" {
  service            = "cloudbuild.googleapis.com"
  disable_on_destroy = false
}

# Storage bucket for function source code
resource "google_storage_bucket" "{{snakeCase functionName}}_source" {
  name                        = "{{projectId}}-{{functionName}}-source"
  location                    = var.region
  uniform_bucket_level_access = true

  labels = {
    name        = "{{functionName}}-source"
    environment = var.environment
    managed-by  = "terraform"
    project     = var.project_name
  }

  depends_on = [google_project_service.cloudfunctions]
}

# Archive function source code
data "archive_file" "{{snakeCase functionName}}_source" {
  type        = "zip"
  output_path = "${path.module}/{{functionName}}.zip"

  # Update this path to your actual function source code directory
  source_dir = "${path.module}/function-src"
}

# Upload function source to Cloud Storage
resource "google_storage_bucket_object" "{{snakeCase functionName}}_zip" {
  name   = "{{functionName}}-${data.archive_file.{{snakeCase functionName}}_source.output_md5}.zip"
  bucket = google_storage_bucket.{{snakeCase functionName}}_source.name
  source = data.archive_file.{{snakeCase functionName}}_source.output_path
}

# Cloud Function (2nd generation)
resource "google_cloudfunctions2_function" "{{snakeCase functionName}}" {
  name     = var.function_name
  location = var.region

  build_config {
    runtime     = var.runtime
    entry_point = var.entry_point

    source {
      storage_source {
        bucket = google_storage_bucket.{{snakeCase functionName}}_source.name
        object = google_storage_bucket_object.{{snakeCase functionName}}_zip.name
      }
    }
  }

  service_config {
    max_instance_count = var.max_instances
    min_instance_count = var.min_instances
    available_memory   = "${var.memory_size}Mi"
    timeout_seconds    = var.timeout

    environment_variables = {
      ENVIRONMENT           = var.environment
      FIRESTORE_DATABASE_ID = google_firestore_database.{{snakeCase databaseName}}.name
      PROJECT_ID            = var.project_id
      {{#if customEnvVars}}
      {{#each customEnvVars}}
      {{@key}} = "{{this}}"
      {{/each}}
      {{/if}}
    }

    {{#if enablePublicAccess}}
    ingress_settings               = "ALLOW_ALL"
    all_traffic_on_latest_revision = true
    {{else}}
    ingress_settings               = "ALLOW_INTERNAL_ONLY"
    all_traffic_on_latest_revision = true
    {{/if}}

    {{#if enableVpc}}
    vpc_connector                  = var.vpc_connector
    vpc_connector_egress_settings  = "ALL_TRAFFIC"
    {{/if}}
  }

  labels = {
    name        = var.function_name
    environment = var.environment
    managed-by  = "terraform"
    project     = var.project_name
  }

  depends_on = [
    google_project_service.cloudfunctions,
    google_project_service.run,
    google_project_service.cloudbuild
  ]
}

{{#if enablePublicAccess}}
# IAM binding to allow public access
resource "google_cloud_run_service_iam_binding" "{{snakeCase functionName}}_public" {
  location = google_cloudfunctions2_function.{{snakeCase functionName}}.location
  service  = google_cloudfunctions2_function.{{snakeCase functionName}}.name
  role     = "roles/run.invoker"
  members  = ["allUsers"]
}
{{/if}}

{{#unless enablePublicAccess}}
# IAM binding for authenticated users only
resource "google_cloud_run_service_iam_binding" "{{snakeCase functionName}}_authenticated" {
  location = google_cloudfunctions2_function.{{snakeCase functionName}}.location
  service  = google_cloudfunctions2_function.{{snakeCase functionName}}.name
  role     = "roles/run.invoker"
  members  = [
    "serviceAccount:${var.project_id}@appspot.gserviceaccount.com"
  ]
}
{{/unless}}

# Firestore Database (Native mode)
resource "google_firestore_database" "{{snakeCase databaseName}}" {
  project     = var.project_id
  name        = var.database_name
  location_id = var.firestore_location
  type        = var.firestore_type

  # Prevent accidental deletion in production
  {{#if eq environment "prod"}}
  deletion_policy = "ABANDON"
  {{else}}
  deletion_policy = "DELETE"
  {{/if}}

  {{#if eq environment "prod"}}
  # Point-in-time recovery for production
  point_in_time_recovery_enablement = "POINT_IN_TIME_RECOVERY_ENABLED"
  {{/if}}

  depends_on = [google_project_service.firestore]
}
