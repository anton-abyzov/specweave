# GCP Cloud Functions + Firestore Terraform Configuration

**Generated by SpecWeave Serverless Architecture Intelligence**

This Terraform configuration deploys:
- Cloud Functions (2nd gen) with HTTP trigger
- Firestore database (Native mode)
- Cloud Storage bucket for function source code
- Service Account with Firestore access
{{#if enableSecretManager}}- Secret Manager for sensitive configuration{{/if}}
{{#if enableVpc}}- VPC Access Connector for private networking{{/if}}

## Architecture

```
Cloud Function ({{functionName}})
    ├── Runtime: {{runtime}}
    ├── Memory: {{memoryMb}} MB
    ├── Timeout: {{timeoutSeconds}}s
    ├── Min Instances: {{minInstances}} ({{#if (eq minInstances 0)}}scales to zero{{else}}always-on{{/if}})
    └── Max Instances: {{maxInstances}}

Firestore Database ({{databaseId}})
    ├── Type: FIRESTORE_NATIVE
    ├── Location: {{region}}
    └── Collection: {{collectionId}}

Service Account ({{serviceAccountId}})
    └── Roles: roles/datastore.user{{#if enableSecretManager}}, roles/secretmanager.secretAccessor{{/if}}

Cloud Storage ({{bucketName}})
    ├── Location: {{bucketLocation}}
    └── Purpose: Function source code
```

## Prerequisites

1. **GCP Project** with billing enabled:
   ```bash
   gcloud config set project {{projectId}}
   ```

2. **gcloud CLI** authenticated:
   ```bash
   gcloud auth application-default login
   ```

3. **Terraform** v1.5.0+ installed:
   ```bash
   terraform version
   ```

4. **Function source code** ready to deploy:
   - Node.js: `package.json`, `index.js`, etc.
   - Python: `requirements.txt`, `main.py`, etc.
   - Go: `go.mod`, `main.go`, etc.

5. **Zip function source code**:
   ```bash
   cd ../src  # Navigate to your function source code
   zip -r ../infrastructure/function-source.zip .
   cd ../infrastructure
   ```

## Deployment Instructions

### 1. Initialize Terraform

```bash
terraform init
```

### 2. Review the Plan

```bash
terraform plan
```

**Expected resources**: ~{{#if enableVpc}}10{{else if enableSecretManager}}9{{else}}7{{/if}} resources will be created

### 3. Deploy Infrastructure

**Development**:
```bash
terraform apply -var-file="environments/dev.tfvars"
```

**Staging**:
```bash
terraform apply -var-file="environments/staging.tfvars"
```

**Production**:
```bash
terraform apply -var-file="environments/prod.tfvars"
```

### 4. Deploy Function Code (Alternative)

You can also deploy function code using `gcloud`:

```bash
gcloud functions deploy {{functionName}} \
  --gen2 \
  --runtime={{runtime}} \
  --region={{region}} \
  --source=../src \
  --entry-point={{entryPoint}} \
  --trigger-http \
  --allow-unauthenticated
```

### 5. Test Your Function

```bash
# Get function URL
FUNCTION_URL=$(terraform output -raw function_url)

# Test HTTP trigger
curl "${FUNCTION_URL}"
```

## Cost Estimation

### Development Environment

**Cloud Functions (2nd gen)**:
- Invocations: 2M/month = Free (2M free tier)
- Compute time: 400,000 GB-s/month = Free (free tier)
- Networking: 5 GB egress = Free (1 GB free, then $0.12/GB)
- **Total**: $0/month (within free tier)

**Firestore**:
- Stored data: 1 GB = Free (1 GB free tier)
- Document reads: 50K/day = Free (50K free tier)
- Document writes: 20K/day = Free (20K free tier)
- Document deletes: 20K/day = Free (20K free tier)
- **Total**: $0/month (within free tier)

**Cloud Storage**:
- Storage: < 5 GB = Free (5 GB free tier)
- Class A operations: Minimal cost
- Class B operations: Free (50K free tier)
- **Total**: $0/month (within free tier)

**Total Monthly Cost (Dev)**: $0/month

{{#if (eq environment "prod")}}
### Production Environment (Estimated)

**Note**: Production costs depend on actual usage. Estimate above assumes:
- 10M requests/month
- 5 GB Firestore storage
- 100K document writes/day

For accurate production estimates, use [GCP Pricing Calculator](https://cloud.google.com/products/calculator).
{{/if}}

## Free Tier Optimization Tips

1. **Cloud Functions**:
   - Keep min_instances = 0 to scale to zero
   - Use 256 MB memory (good balance of performance/cost)
   - Set appropriate timeout (avoid long-running functions)
   - Stay under 2M invocations/month for free tier

2. **Firestore**:
   - Use composite indexes wisely (counts against storage)
   - Batch writes when possible (reduces write operations)
   - Use server-side timestamps (avoids extra writes)
   - Monitor read/write quota in console

3. **Cloud Storage**:
   - Store only function source code (minimal storage)
   - Use lifecycle policies to delete old versions
   - Stay under 5 GB for free tier

4. **Networking**:
   - Minimize egress (first 1 GB free)
   - Use Cloud CDN for static assets
   - Keep responses small

## Monitoring

**Cloud Logging** and **Cloud Monitoring** are enabled by default.

View logs:
```bash
gcloud functions logs read {{functionName}} \
  --region={{region}} \
  --limit=50
```

View metrics in Cloud Console:
```
https://console.cloud.google.com/functions/details/{{region}}/{{functionName}}?project={{projectId}}
```

Key metrics to monitor:
- Invocation count
- Execution time (p50, p95, p99)
- Error count and error rate
- Active instances
- Memory usage

## Security Best Practices

1. **Service Account**: Function uses dedicated Service Account
   - ✅ Least privilege principle (only Firestore access)
   - ✅ No default compute service account

2. **Secrets Management**:
{{#if enableSecretManager}}
   - ✅ Secret Manager enabled
   - Store sensitive config in Secret Manager
   - Access via `google_secret_manager_secret_version` data source
{{else}}
   - ⚠️ Secret Manager not enabled
   - Enable with `enableSecretManager = true`
{{/if}}

3. **HTTPS Only**: Function enforces HTTPS
4. **CORS**: Configured for origins: {{corsOrigins}}
5. **Network Security**:
{{#if enableVpc}}
   - ✅ VPC Connector enabled for private networking
{{else}}
   - ⚠️ Public internet access (no VPC)
   - Enable with `enableVpc = true`
{{/if}}

6. **IAM**: Function allows unauthenticated invocations
   - ⚠️ Change `allUsers` to specific members for private APIs
   - Use Cloud Armor for DDoS protection (production)

## Cleanup

To destroy all resources:

```bash
terraform destroy
```

**Warning**: This will permanently delete:
- Cloud Function and all code
- Firestore database and all data
- Storage bucket and all objects
- Service Account

## Troubleshooting

### "Project not found"
- Ensure GCP project exists and billing is enabled
- Run `gcloud config set project {{projectId}}`
- Verify with `gcloud projects describe {{projectId}}`

### "API not enabled"
- APIs are enabled automatically by Terraform
- If issues persist, manually enable:
  ```bash
  gcloud services enable cloudfunctions.googleapis.com
  gcloud services enable cloudbuild.googleapis.com
  gcloud services enable firestore.googleapis.com
  ```

### "Insufficient permissions"
- Ensure you have `roles/editor` or `roles/owner` on project
- Check with: `gcloud projects get-iam-policy {{projectId}}`

### "function-source.zip not found"
- Create zip file from your function source code:
  ```bash
  cd ../src
  zip -r ../infrastructure/function-source.zip .
  ```

### "Function not responding"
- Check Cloud Logging for errors
- Verify function code has correct entry point
- Check CORS settings if calling from browser

## Next Steps

1. **Deploy your function code** (see step 4-5 above)
2. **Set up CI/CD** with Cloud Build or GitHub Actions
3. **Configure custom domains** for production
4. **Set up monitoring alerts** in Cloud Monitoring
5. **Enable Cloud Armor** for DDoS protection (production)

## Support

- **GCP Documentation**: https://cloud.google.com/functions/docs
- **Terraform GCP Provider**: https://registry.terraform.io/providers/hashicorp/google/
- **SpecWeave**: https://spec-weave.com

---

**Generated**: {{currentDate}}
**SpecWeave Version**: {{specweaveVersion}}
