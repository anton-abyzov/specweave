# {{functionName}} - AWS Lambda Serverless Infrastructure

**Generated by SpecWeave Serverless Architecture Intelligence**

## Overview

This Terraform configuration deploys a complete serverless application stack on AWS:

- **Lambda Function**: `{{functionName}}` ({{runtime}}, {{memorySize}}MB memory, {{timeout}}s timeout)
- **API Gateway**: HTTP API with CORS support
- **DynamoDB**: NoSQL database table `{{databaseName}}`
- **CloudWatch Logs**: Centralized logging with {{logRetentionDays}}-day retention
{{#if enableVpc}}- **VPC Integration**: Secure network isolation{{/if}}
{{#if enableXray}}- **X-Ray Tracing**: Distributed tracing enabled{{/if}}
{{#if enableSecretsManager}}- **Secrets Manager**: Secure secret storage{{/if}}

## Architecture

```
┌─────────────┐
│   Client    │
└──────┬──────┘
       │ HTTPS
       v
┌─────────────────┐
│  API Gateway    │
│  (HTTP API)     │
└──────┬──────────┘
       │
       v
┌────────────────────┐      ┌──────────────┐
│  Lambda Function   │─────>│  DynamoDB    │
│  {{functionName}}  │      │  {{databaseName}} │
└────────────────────┘      └──────────────┘
       │
       v
┌────────────────────┐
│ CloudWatch Logs    │
└────────────────────┘
```

## Prerequisites

1. **AWS CLI** configured with credentials:
   ```bash
   aws configure
   ```

2. **Terraform** v1.5.0 or higher:
   ```bash
   terraform version
   ```

3. **Lambda deployment package** ({{functionName}}.zip):
   - Create your Lambda function code
   - Package as {{functionName}}.zip
   - Place in the same directory as this README

## Deployment Instructions

### Step 1: Initialize Terraform

```bash
terraform init
```

This downloads the AWS provider and initializes the backend.

### Step 2: Review Configuration

Edit `terraform.tfvars` (or create environment-specific files like `dev.tfvars`) to customize:

```hcl
aws_region     = "{{region}}"
function_name  = "{{functionName}}"
environment    = "{{environment}}"
runtime        = "{{runtime}}"
memory_size    = {{memorySize}}
timeout        = {{timeout}}
database_name  = "{{databaseName}}"
primary_key    = "{{primaryKey}}"
project_name   = "{{projectName}}"
```

### Step 3: Plan Deployment

```bash
terraform plan
```

Review the resources that will be created:
- 1× Lambda Function
- 1× API Gateway HTTP API
- 1× DynamoDB Table
- 2× CloudWatch Log Groups
- 1× IAM Role + Policies
{{#if enableVpc}}- 1× Security Group (VPC){{/if}}

### Step 4: Deploy

```bash
terraform apply
```

Type `yes` when prompted to confirm deployment.

### Step 5: Verify Deployment

After successful deployment, Terraform will output:

```
api_endpoint = "https://xxxxxxxxxx.execute-api.{{region}}.amazonaws.com/{{apiStageName}}"
function_name = "{{functionName}}"
table_name = "{{databaseName}}"
```

Test your API:

```bash
curl https://xxxxxxxxxx.execute-api.{{region}}.amazonaws.com/{{apiStageName}}
```

## Environment-Specific Deployments

Deploy to different environments using tfvars files:

```bash
# Development
terraform apply -var-file="environments/dev.tfvars"

# Staging
terraform apply -var-file="environments/staging.tfvars"

# Production
terraform apply -var-file="environments/prod.tfvars"
```

## Cost Optimization

### Free Tier Limits (First 12 Months)

- **Lambda**: 1M requests/month + 400,000 GB-seconds compute
- **API Gateway**: 1M API calls/month (first 12 months)
- **DynamoDB**: 25GB storage + 25 WCU + 25 RCU (always free)
- **CloudWatch Logs**: 5GB ingestion + 5GB storage

### Estimated Monthly Cost (After Free Tier)

**{{environment}} Environment**:
{{#if eq environment "dev"}}
- **Lambda**: ~$0.20/month (10K requests, 128MB, 1s avg duration)
- **API Gateway**: ~$0.10/month (10K requests)
- **DynamoDB**: $0.00/month (PAY_PER_REQUEST under free tier)
- **CloudWatch Logs**: ~$0.50/month (1GB logs)
- **Total**: ~$0.80/month
{{else}}{{#if eq environment "staging"}}
- **Lambda**: ~$2.00/month (100K requests, 256MB, 1s avg duration)
- **API Gateway**: ~$1.00/month (100K requests)
- **DynamoDB**: ~$1.25/month (PAY_PER_REQUEST, light usage)
- **CloudWatch Logs**: ~$1.00/month (2GB logs)
- **Total**: ~$5.25/month
{{else}}
- **Lambda**: ~$20.00/month (1M requests, 512MB, 1s avg duration)
- **API Gateway**: ~$10.00/month (1M requests)
- **DynamoDB**: ~$12.50/month (PROVISIONED, 5 RCU/WCU)
- **CloudWatch Logs**: ~$5.00/month (10GB logs)
- **Total**: ~$47.50/month
{{/if}}{{/if}}

### Cost Optimization Tips

1. **Right-size memory**: Test with different memory settings (128MB, 256MB, 512MB)
2. **Optimize timeout**: Reduce timeout to actual function duration
3. **Use PAY_PER_REQUEST**: For low-traffic apps (<100K requests/month)
4. **Enable CloudWatch Logs retention**: Delete old logs automatically
5. **Monitor cold starts**: Use Provisioned Concurrency if needed ($$)

## Security Best Practices

✅ **Implemented**:
- IAM least privilege roles
- HTTPS-only API Gateway
- CloudWatch Logs encryption
- DynamoDB encryption at rest (if enabled)
- Secrets Manager for sensitive data (if enabled)

⚠️ **Additional Recommendations**:
- Enable AWS WAF for API Gateway
- Implement rate limiting
- Use AWS Shield for DDoS protection
- Enable VPC for database access
- Rotate secrets regularly

## Monitoring and Logging

### CloudWatch Logs

View Lambda logs:
```bash
aws logs tail /aws/lambda/{{functionName}} --follow
```

View API Gateway logs:
```bash
aws logs tail /aws/apigateway/{{apiName}}-{{environment}} --follow
```

### CloudWatch Metrics

Monitor in AWS Console:
- Lambda: Invocations, Duration, Errors, Throttles
- API Gateway: Count, Latency, 4XX/5XX errors
- DynamoDB: Read/Write capacity, Throttled requests

## Cleanup

To destroy all resources:

```bash
terraform destroy
```

Type `yes` to confirm deletion.

**Warning**: This will permanently delete:
- Lambda function
- API Gateway
- DynamoDB table (and all data)
- CloudWatch Logs

## Troubleshooting

### Lambda Function Not Working

1. Check CloudWatch Logs for errors
2. Verify IAM role permissions
3. Test function locally with AWS SAM

### API Gateway 403 Errors

1. Verify Lambda permission for API Gateway
2. Check CORS configuration
3. Review API Gateway execution logs

### DynamoDB Access Denied

1. Verify Lambda IAM role has DynamoDB permissions
2. Check table name matches environment variable
3. Verify primary key schema

## Support

For issues with this Terraform configuration, contact your SpecWeave administrator or file an issue at https://github.com/anton-abyzov/specweave/issues.

## Additional Resources

- [AWS Lambda Documentation](https://docs.aws.amazon.com/lambda/)
- [API Gateway HTTP API Guide](https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api.html)
- [DynamoDB Developer Guide](https://docs.aws.amazon.com/dynamodb/)
- [Terraform AWS Provider](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
