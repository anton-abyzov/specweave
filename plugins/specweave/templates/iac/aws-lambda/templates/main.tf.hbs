# AWS Lambda + API Gateway + DynamoDB Terraform Configuration
# Generated by SpecWeave Serverless Architecture Intelligence

# Lambda Function
resource "aws_lambda_function" "{{snakeCase functionName}}" {
  filename      = "{{functionName}}.zip"
  function_name = "{{functionName}}"
  role          = aws_iam_role.lambda_exec.arn
  handler       = "{{handler}}"
  runtime       = "{{runtime}}"

  memory_size = {{memorySize}}
  timeout     = {{timeout}}

  environment {
    variables = {
      ENVIRONMENT   = "{{environment}}"
      TABLE_NAME    = aws_dynamodb_table.{{snakeCase databaseName}}.name
      {{#if customEnvVars}}
      {{#each customEnvVars}}
      {{@key}} = "{{this}}"
      {{/each}}
      {{/if}}
    }
  }

  {{#if enableVpc}}
  vpc_config {
    subnet_ids         = var.subnet_ids
    security_group_ids = [aws_security_group.lambda_sg.id]
  }
  {{/if}}

  {{#if enableXray}}
  tracing_config {
    mode = "Active"
  }
  {{/if}}

  tags = {
    Name        = "{{functionName}}"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
    Project     = "{{projectName}}"
  }
}

# API Gateway HTTP API
resource "aws_apigatewayv2_api" "{{snakeCase apiName}}" {
  name          = "{{apiName}}"
  protocol_type = "HTTP"

  cors_configuration {
    allow_origins = {{tfList corsOrigins}}
    allow_methods = ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
    allow_headers = ["content-type", "authorization"]
    max_age       = 300
  }

  tags = {
    Name        = "{{apiName}}"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }
}

# API Gateway Stage
resource "aws_apigatewayv2_stage" "{{snakeCase apiStageName}}" {
  api_id      = aws_apigatewayv2_api.{{snakeCase apiName}}.id
  name        = "{{apiStageName}}"
  auto_deploy = true

  access_log_settings {
    destination_arn = aws_cloudwatch_log_group.api_logs.arn
    format = jsonencode({
      requestId      = "$context.requestId"
      ip             = "$context.identity.sourceIp"
      requestTime    = "$context.requestTime"
      httpMethod     = "$context.httpMethod"
      routeKey       = "$context.routeKey"
      status         = "$context.status"
      protocol       = "$context.protocol"
      responseLength = "$context.responseLength"
    })
  }

  tags = {
    Name        = "{{apiStageName}}"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }
}

# API Gateway Integration
resource "aws_apigatewayv2_integration" "lambda" {
  api_id = aws_apigatewayv2_api.{{snakeCase apiName}}.id

  integration_uri    = aws_lambda_function.{{snakeCase functionName}}.invoke_arn
  integration_type   = "AWS_PROXY"
  integration_method = "POST"
}

# API Gateway Route - Catch all
resource "aws_apigatewayv2_route" "proxy" {
  api_id    = aws_apigatewayv2_api.{{snakeCase apiName}}.id
  route_key = "$default"

  target = "integrations/${aws_apigatewayv2_integration.lambda.id}"
}

# Lambda permission for API Gateway
resource "aws_lambda_permission" "api_gw" {
  statement_id  = "AllowExecutionFromAPIGateway"
  action        = "lambda:InvokeFunction"
  function_name = aws_lambda_function.{{snakeCase functionName}}.function_name
  principal     = "apigateway.amazonaws.com"

  source_arn = "${aws_apigatewayv2_api.{{snakeCase apiName}}.execution_arn}/*/*"
}

# DynamoDB Table
resource "aws_dynamodb_table" "{{snakeCase databaseName}}" {
  name           = "{{databaseName}}"
  billing_mode   = "{{#if eq environment "prod"}}PROVISIONED{{else}}PAY_PER_REQUEST{{/if}}"
  hash_key       = "{{primaryKey}}"
  {{#if sortKey}}
  range_key      = "{{sortKey}}"
  {{/if}}

  {{#if eq environment "prod"}}
  read_capacity  = 5
  write_capacity = 5
  {{/if}}

  attribute {
    name = "{{primaryKey}}"
    type = "S"
  }

  {{#if sortKey}}
  attribute {
    name = "{{sortKey}}"
    type = "S"
  }
  {{/if}}

  {{#if enableEncryption}}
  server_side_encryption {
    enabled     = true
    kms_key_arn = var.kms_key_arn
  }
  {{/if}}

  {{#if enablePointInTimeRecovery}}
  point_in_time_recovery {
    enabled = true
  }
  {{/if}}

  {{#if enableStreams}}
  stream_enabled   = true
  stream_view_type = "NEW_AND_OLD_IMAGES"
  {{/if}}

  tags = {
    Name        = "{{databaseName}}"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }
}

# CloudWatch Log Group for API Gateway
resource "aws_cloudwatch_log_group" "api_logs" {
  name              = "/aws/apigateway/{{apiName}}-{{environment}}"
  retention_in_days = {{logRetentionDays}}

  tags = {
    Name        = "{{apiName}}-logs"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }
}

# CloudWatch Log Group for Lambda
resource "aws_cloudwatch_log_group" "lambda_logs" {
  name              = "/aws/lambda/{{functionName}}"
  retention_in_days = {{logRetentionDays}}

  tags = {
    Name        = "{{functionName}}-logs"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }
}

{{#if enableVpc}}
# Security Group for Lambda (if VPC enabled)
resource "aws_security_group" "lambda_sg" {
  name        = "{{functionName}}-sg"
  description = "Security group for Lambda function {{functionName}}"
  vpc_id      = var.vpc_id

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }

  tags = {
    Name        = "{{functionName}}-sg"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }
}
{{/if}}
