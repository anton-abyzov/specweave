# Azure Functions + Cosmos DB Terraform Configuration
# Generated by SpecWeave Serverless Architecture Intelligence

# Resource Group
resource "azurerm_resource_group" "{{snakeCase resourceGroupName}}" {
  name     = "{{resourceGroupName}}"
  location = "{{location}}"

  tags = {
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
    Project     = "{{projectName}}"
  }
}

# Storage Account (required for Function App)
resource "azurerm_storage_account" "{{snakeCase functionName}}" {
  name                     = "{{snakeCase functionName}}storage"
  resource_group_name      = azurerm_resource_group.{{snakeCase resourceGroupName}}.name
  location                 = azurerm_resource_group.{{snakeCase resourceGroupName}}.location
  account_tier             = "{{storageAccountTier}}"
  account_replication_type = "{{storageAccountReplication}}"

  tags = {
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
    Project     = "{{projectName}}"
  }
}

# App Service Plan (Consumption Plan)
resource "azurerm_service_plan" "{{snakeCase functionName}}" {
  name                = "{{appName}}-plan"
  resource_group_name = azurerm_resource_group.{{snakeCase resourceGroupName}}.name
  location            = azurerm_resource_group.{{snakeCase resourceGroupName}}.location
  os_type             = "{{osType}}"
  sku_name            = "{{skuName}}"

  tags = {
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
    Project     = "{{projectName}}"
  }
}

{{#if enableApplicationInsights}}
# Application Insights
resource "azurerm_application_insights" "{{snakeCase functionName}}" {
  name                = "{{appName}}-insights"
  resource_group_name = azurerm_resource_group.{{snakeCase resourceGroupName}}.name
  location            = azurerm_resource_group.{{snakeCase resourceGroupName}}.location
  application_type    = "web"

  tags = {
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
    Project     = "{{projectName}}"
  }
}
{{/if}}

# Linux Function App
resource "azurerm_linux_function_app" "{{snakeCase functionName}}" {
  name                = "{{appName}}"
  resource_group_name = azurerm_resource_group.{{snakeCase resourceGroupName}}.name
  location            = azurerm_resource_group.{{snakeCase resourceGroupName}}.location

  storage_account_name       = azurerm_storage_account.{{snakeCase functionName}}.name
  storage_account_access_key = azurerm_storage_account.{{snakeCase functionName}}.primary_access_key
  service_plan_id            = azurerm_service_plan.{{snakeCase functionName}}.id

  site_config {
    application_stack {
      {{#if (eq runtime "node")}}
      node_version = "{{runtimeVersion}}"
      {{else if (eq runtime "python")}}
      python_version = "{{runtimeVersion}}"
      {{else if (eq runtime "dotnet")}}
      dotnet_version = "{{runtimeVersion}}"
      {{/if}}
    }

    cors {
      allowed_origins = {{tfList corsOrigins}}
    }

    {{#if enableApplicationInsights}}
    application_insights_key             = azurerm_application_insights.{{snakeCase functionName}}.instrumentation_key
    application_insights_connection_string = azurerm_application_insights.{{snakeCase functionName}}.connection_string
    {{/if}}
  }

  app_settings = {
    "ENVIRONMENT"                  = "{{environment}}"
    "COSMOS_DB_ENDPOINT"           = azurerm_cosmosdb_account.{{snakeCase databaseAccountName}}.endpoint
    "COSMOS_DB_KEY"                = azurerm_cosmosdb_account.{{snakeCase databaseAccountName}}.primary_key
    "COSMOS_DB_DATABASE"           = azurerm_cosmosdb_sql_database.{{snakeCase databaseName}}.name
    "COSMOS_DB_CONTAINER"          = azurerm_cosmosdb_sql_container.{{snakeCase containerName}}.name
    "FUNCTIONS_WORKER_RUNTIME"     = "{{runtime}}"
    {{#if customAppSettings}}
    {{#each customAppSettings}}
    "{{@key}}" = "{{this}}"
    {{/each}}
    {{/if}}
  }

  identity {
    type = "SystemAssigned"
  }

  tags = {
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
    Project     = "{{projectName}}"
  }
}

# Cosmos DB Account
resource "azurerm_cosmosdb_account" "{{snakeCase databaseAccountName}}" {
  name                = "{{databaseAccountName}}"
  resource_group_name = azurerm_resource_group.{{snakeCase resourceGroupName}}.name
  location            = azurerm_resource_group.{{snakeCase resourceGroupName}}.location
  offer_type          = "Standard"
  kind                = "GlobalDocumentDB"

  consistency_policy {
    consistency_level       = "Session"
    max_interval_in_seconds = 5
    max_staleness_prefix    = 100
  }

  geo_location {
    location          = azurerm_resource_group.{{snakeCase resourceGroupName}}.location
    failover_priority = 0
  }

  {{#if enableMultiRegion}}
  {{#each secondaryRegions}}
  geo_location {
    location          = "{{this}}"
    failover_priority = {{@index}}
  }
  {{/each}}
  {{/if}}

  {{#if enableAutomaticFailover}}
  enable_automatic_failover = true
  {{/if}}

  {{#if enableBackup}}
  backup {
    type                = "Continuous"
    interval_in_minutes = 240
    retention_in_hours  = 8
  }
  {{/if}}

  tags = {
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
    Project     = "{{projectName}}"
  }
}

# Cosmos DB SQL Database
resource "azurerm_cosmosdb_sql_database" "{{snakeCase databaseName}}" {
  name                = "{{databaseName}}"
  resource_group_name = azurerm_resource_group.{{snakeCase resourceGroupName}}.name
  account_name        = azurerm_cosmosdb_account.{{snakeCase databaseAccountName}}.name
}

# Cosmos DB SQL Container
resource "azurerm_cosmosdb_sql_container" "{{snakeCase containerName}}" {
  name                  = "{{containerName}}"
  resource_group_name   = azurerm_resource_group.{{snakeCase resourceGroupName}}.name
  account_name          = azurerm_cosmosdb_account.{{snakeCase databaseAccountName}}.name
  database_name         = azurerm_cosmosdb_sql_database.{{snakeCase databaseName}}.name
  partition_key_path    = "{{partitionKey}}"
  partition_key_version = 1
  throughput            = {{throughput}}

  indexing_policy {
    indexing_mode = "consistent"

    included_path {
      path = "/*"
    }

    excluded_path {
      path = "/\"_etag\"/?"
    }
  }
}

{{#if enableKeyVault}}
# Key Vault
resource "azurerm_key_vault" "{{snakeCase functionName}}" {
  name                       = "{{appName}}-kv"
  resource_group_name        = azurerm_resource_group.{{snakeCase resourceGroupName}}.name
  location                   = azurerm_resource_group.{{snakeCase resourceGroupName}}.location
  tenant_id                  = data.azurerm_client_config.current.tenant_id
  sku_name                   = "standard"
  soft_delete_retention_days = 7
  purge_protection_enabled   = false

  access_policy {
    tenant_id = data.azurerm_client_config.current.tenant_id
    object_id = azurerm_linux_function_app.{{snakeCase functionName}}.identity[0].principal_id

    secret_permissions = [
      "Get",
      "List"
    ]
  }

  tags = {
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
    Project     = "{{projectName}}"
  }
}

# Data source for current Azure client config
data "azurerm_client_config" "current" {}
{{/if}}
