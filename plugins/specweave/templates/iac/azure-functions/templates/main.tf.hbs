# Azure Functions + Cosmos DB + Application Insights Terraform Configuration
# Generated by SpecWeave Serverless Architecture Intelligence

# Resource Group
resource "azurerm_resource_group" "{{snakeCase resourceGroupName}}" {
  name     = "{{resourceGroupName}}"
  location = "{{location}}"

  tags = {
    Name        = "{{resourceGroupName}}"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
    Project     = "{{projectName}}"
  }
}

# Storage Account (required for Function App)
resource "azurerm_storage_account" "{{snakeCase storageAccountName}}" {
  name                     = "{{storageAccountName}}"
  resource_group_name      = azurerm_resource_group.{{snakeCase resourceGroupName}}.name
  location                 = azurerm_resource_group.{{snakeCase resourceGroupName}}.location
  account_tier             = "Standard"
  account_replication_type = "{{#if enableZoneRedundancy}}ZRS{{else}}LRS{{/if}}"

  tags = {
    Name        = "{{storageAccountName}}"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }
}

# App Service Plan
resource "azurerm_service_plan" "{{snakeCase functionName}}" {
  name                = "{{functionName}}-plan"
  resource_group_name = azurerm_resource_group.{{snakeCase resourceGroupName}}.name
  location            = azurerm_resource_group.{{snakeCase resourceGroupName}}.location
  os_type             = "{{uppercase osType}}"
  sku_name            = "{{skuSize}}"

  {{#if enableZoneRedundancy}}
  zone_balancing_enabled = true
  {{/if}}

  tags = {
    Name        = "{{functionName}}-plan"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }
}

# {{#if (eq osType "linux")}}Linux{{else}}Windows{{/if}} Function App
resource "azurerm_{{lowercase osType}}_function_app" "{{snakeCase functionName}}" {
  name                = "{{functionName}}"
  resource_group_name = azurerm_resource_group.{{snakeCase resourceGroupName}}.name
  location            = azurerm_resource_group.{{snakeCase resourceGroupName}}.location

  storage_account_name       = azurerm_storage_account.{{snakeCase storageAccountName}}.name
  storage_account_access_key = azurerm_storage_account.{{snakeCase storageAccountName}}.primary_access_key
  service_plan_id            = azurerm_service_plan.{{snakeCase functionName}}.id

  site_config {
    {{#if (eq runtime "node")}}
    application_stack {
      node_version = "{{runtimeVersion}}"
    }
    {{else}}{{#if (eq runtime "python")}}
    application_stack {
      python_version = "{{runtimeVersion}}"
    }
    {{else}}{{#if (eq runtime "dotnet")}}
    application_stack {
      dotnet_version = "{{runtimeVersion}}"
    }
    {{/if}}{{/if}}{{/if}}

    cors {
      allowed_origins = {{tfList corsOrigins}}
    }

    {{#if enableApplicationInsights}}
    application_insights_connection_string = azurerm_application_insights.{{snakeCase functionName}}.connection_string
    application_insights_key               = azurerm_application_insights.{{snakeCase functionName}}.instrumentation_key
    {{/if}}
  }

  app_settings = {
    FUNCTIONS_WORKER_RUNTIME       = "{{runtime}}"
    COSMOS_DB_CONNECTION_STRING    = azurerm_cosmosdb_account.{{snakeCase databaseName}}.connection_strings[0]
    COSMOS_DB_DATABASE_NAME        = "{{databaseName}}"
    COSMOS_DB_ENDPOINT             = azurerm_cosmosdb_account.{{snakeCase databaseName}}.endpoint
    COSMOS_DB_PRIMARY_KEY          = azurerm_cosmosdb_account.{{snakeCase databaseName}}.primary_key
    ENVIRONMENT                    = "{{environment}}"
    {{#if enableApplicationInsights}}
    APPINSIGHTS_INSTRUMENTATIONKEY = azurerm_application_insights.{{snakeCase functionName}}.instrumentation_key
    {{/if}}
  }

  {{#if enableManagedIdentity}}
  identity {
    type = "SystemAssigned"
  }
  {{/if}}

  tags = {
    Name        = "{{functionName}}"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
    Project     = "{{projectName}}"
  }
}

# Cosmos DB Account
resource "azurerm_cosmosdb_account" "{{snakeCase databaseName}}" {
  name                = "{{databaseName}}"
  resource_group_name = azurerm_resource_group.{{snakeCase resourceGroupName}}.name
  location            = azurerm_resource_group.{{snakeCase resourceGroupName}}.location
  offer_type          = "Standard"
  kind                = "GlobalDocumentDB"

  consistency_policy {
    consistency_level = "{{#if (eq environment "prod")}}BoundedStaleness{{else}}Session{{/if}}"
    {{#if (eq environment "prod")}}
    max_interval_in_seconds = 5
    max_staleness_prefix    = 100
    {{/if}}
  }

  geo_location {
    location          = azurerm_resource_group.{{snakeCase resourceGroupName}}.location
    failover_priority = 0
    {{#if enableZoneRedundancy}}
    zone_redundant = true
    {{/if}}
  }

  {{#if enableBackup}}
  backup {
    type                = "Periodic"
    interval_in_minutes = 240
    retention_in_hours  = 720
  }
  {{/if}}

  capabilities {
    name = "EnableServerless"
  }

  tags = {
    Name        = "{{databaseName}}"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }
}

# Cosmos DB SQL Database
resource "azurerm_cosmosdb_sql_database" "{{snakeCase databaseName}}" {
  name                = "{{databaseName}}"
  resource_group_name = azurerm_cosmosdb_account.{{snakeCase databaseName}}.resource_group_name
  account_name        = azurerm_cosmosdb_account.{{snakeCase databaseName}}.name
}

# Cosmos DB SQL Container
resource "azurerm_cosmosdb_sql_container" "{{snakeCase databaseName}}" {
  name                  = "{{databaseName}}-container"
  resource_group_name   = azurerm_cosmosdb_account.{{snakeCase databaseName}}.resource_group_name
  account_name          = azurerm_cosmosdb_account.{{snakeCase databaseName}}.name
  database_name         = azurerm_cosmosdb_sql_database.{{snakeCase databaseName}}.name
  partition_key_path    = "/{{primaryKey}}"
  partition_key_version = 2

  indexing_policy {
    indexing_mode = "consistent"

    included_path {
      path = "/*"
    }
  }

  {{#if cosmosDbThroughput}}
  throughput = {{cosmosDbThroughput}}
  {{/if}}
}

{{#if enableApplicationInsights}}
# Application Insights
resource "azurerm_application_insights" "{{snakeCase functionName}}" {
  name                = "{{functionName}}-insights"
  resource_group_name = azurerm_resource_group.{{snakeCase resourceGroupName}}.name
  location            = azurerm_resource_group.{{snakeCase resourceGroupName}}.location
  application_type    = "web"
  retention_in_days   = {{logRetentionDays}}

  tags = {
    Name        = "{{functionName}}-insights"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }
}
{{/if}}
