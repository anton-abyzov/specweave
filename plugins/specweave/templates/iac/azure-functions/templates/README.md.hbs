# {{functionName}} - Azure Functions Serverless Infrastructure

**Generated by SpecWeave Serverless Architecture Intelligence**

## Overview

This Terraform configuration deploys a complete serverless application stack on Microsoft Azure:

- **Azure Functions**: `{{functionName}}` ({{runtime}} {{runtimeVersion}}, {{osType}}, {{skuSize}} plan)
- **Cosmos DB**: NoSQL database `{{databaseName}}` (serverless mode, {{cosmosDbThroughput}} RU/s)
- **Storage Account**: Required for Function App runtime
- **Application Insights**: Monitoring and telemetry{{#if enableApplicationInsights}} (enabled){{else}} (disabled){{/if}}
{{#if enableManagedIdentity}}- **Managed Identity**: System-assigned identity for secure access{{/if}}

## Architecture

```
┌─────────────┐
│   Client    │
└──────┬──────┘
       │ HTTPS
       v
┌────────────────────┐
│  Azure Functions   │
│  {{functionName}}  │
└──────┬─────────────┘
       │
       v
┌──────────────────┐      ┌──────────────────┐
│   Cosmos DB      │      │ App Insights     │
│  {{databaseName}}│      │  (Monitoring)    │
└──────────────────┘      └──────────────────┘
```

## Prerequisites

1. **Azure CLI** configured with credentials:
   ```bash
   az login
   az account show
   ```

2. **Terraform** v1.5.0 or higher:
   ```bash
   terraform version
   ```

3. **Azure Subscription** with permissions to create resources

4. **Function deployment package**:
   - Create your function code (Node.js, Python, or .NET)
   - Deploy via Azure Functions Core Tools or CI/CD pipeline

## Deployment Instructions

### Step 1: Initialize Terraform

```bash
terraform init
```

This downloads the Azure provider and initializes the backend.

### Step 2: Review Configuration

Edit `terraform.tfvars` (or create environment-specific files like `dev.tfvars`) to customize:

```hcl
location             = "{{location}}"
resource_group_name  = "{{resourceGroupName}}"
function_name        = "{{functionName}}"
runtime              = "{{runtime}}"
runtime_version      = "{{runtimeVersion}}"
os_type              = "{{osType}}"
sku_size             = "{{skuSize}}"
environment          = "{{environment}}"
storage_account_name = "{{storageAccountName}}"
database_name        = "{{databaseName}}"
primary_key          = "{{primaryKey}}"
project_name         = "{{projectName}}"
```

### Step 3: Plan Deployment

```bash
terraform plan
```

Review the resources that will be created:
- 1× Resource Group
- 1× Storage Account
- 1× App Service Plan ({{skuSize}})
- 1× Function App ({{osType}})
- 1× Cosmos DB Account
- 1× Cosmos DB SQL Database
- 1× Cosmos DB SQL Container
{{#if enableApplicationInsights}}- 1× Application Insights{{/if}}

### Step 4: Deploy

```bash
terraform apply
```

Type `yes` when prompted to confirm deployment.

### Step 5: Verify Deployment

After successful deployment, Terraform will output:

```
function_url = "https://{{functionName}}.azurewebsites.net"
cosmos_db_endpoint = "https://{{databaseName}}.documents.azure.com:443/"
```

Test your function:

```bash
curl https://{{functionName}}.azurewebsites.net/api/HttpTrigger?name=World
```

## Environment-Specific Deployments

Deploy to different environments using tfvars files:

```bash
# Development
terraform apply -var-file="environments/dev.tfvars"

# Staging
terraform apply -var-file="environments/staging.tfvars"

# Production
terraform apply -var-file="environments/prod.tfvars"
```

## Cost Optimization

### Free Tier Limits

- **Azure Functions**: 1M executions/month + 400,000 GB-s compute (always free)
- **Cosmos DB**: First 1,000 RU/s + 25 GB storage free (always free)
- **Storage Account**: 5 GB LRS hot storage + 20,000 read/write operations
- **Application Insights**: 5 GB data ingestion/month

### Estimated Monthly Cost (After Free Tier)

**{{environment}} Environment**:
{{#if (eq environment "dev")}}
- **Azure Functions**: $0.00/month (within free tier)
- **Cosmos DB**: $0.00/month (serverless, within free tier)
- **Storage Account**: ~$0.50/month
- **Application Insights**: $0.00/month (within free tier)
- **Total**: ~$0.50/month
{{else}}{{#if (eq environment "staging")}}
- **Azure Functions**: ~$15.00/month (Premium EP1 plan)
- **Cosmos DB**: ~$5.00/month (serverless, 5K RU/s avg)
- **Storage Account**: ~$2.00/month
- **Application Insights**: ~$2.00/month
- **Total**: ~$24.00/month
{{else}}
- **Azure Functions**: ~$80.00/month (Premium EP2 plan, zone redundancy)
- **Cosmos DB**: ~$50.00/month (provisioned throughput, zone redundancy)
- **Storage Account**: ~$10.00/month (ZRS)
- **Application Insights**: ~$10.00/month
- **Total**: ~$150.00/month
{{/if}}{{/if}}

### Cost Optimization Tips

1. **Use Consumption Plan (Y1) for low-traffic apps**: No upfront costs
2. **Enable Cosmos DB serverless mode**: Pay only for consumed RU/s
3. **Right-size Premium Plans**: Start with EP1, scale up if needed
4. **Set Application Insights sampling**: Reduce data ingestion costs
5. **Use LRS storage**: Switch to ZRS only for production

## Security Best Practices

✅ **Implemented**:
- HTTPS-only function endpoints
- Managed Identity for secure Cosmos DB access
- Storage account encryption at rest
- Application Insights data encryption
- CORS configuration

⚠️ **Additional Recommendations**:
- Enable Azure Key Vault for secrets management
- Configure Function App network restrictions
- Enable Cosmos DB firewall rules
- Implement Azure AD authentication
- Enable diagnostic logging

## Monitoring and Logging

### Application Insights

View function logs in Azure Portal:
1. Navigate to Application Insights resource
2. Go to "Logs" section
3. Query traces, requests, and exceptions

```kusto
traces
| where timestamp > ago(1h)
| where customDimensions.Category == "Function"
| order by timestamp desc
```

### Azure CLI Monitoring

View live logs:
```bash
az webapp log tail --name {{functionName}} --resource-group {{resourceGroupName}}
```

View metrics:
```bash
az monitor metrics list \
  --resource {{functionName}} \
  --resource-group {{resourceGroupName}} \
  --resource-type "Microsoft.Web/sites"
```

### Cosmos DB Metrics

Monitor in Azure Portal:
- Request Units consumption
- Storage usage
- Throttled requests
- Latency (P99, P95)

## Deploying Function Code

### Using Azure Functions Core Tools

```bash
# Install Azure Functions Core Tools
npm install -g azure-functions-core-tools@4

# Create function project (if not exists)
func init --{{runtime}}

# Create HTTP trigger function
func new --name HttpTrigger --template "HTTP trigger"

# Deploy to Azure
func azure functionapp publish {{functionName}}
```

### Using Azure CLI

```bash
# Deploy from ZIP file
az functionapp deployment source config-zip \
  --resource-group {{resourceGroupName}} \
  --name {{functionName}} \
  --src function-app.zip
```

## Cleanup

To destroy all resources:

```bash
terraform destroy
```

Type `yes` to confirm deletion.

**Warning**: This will permanently delete:
- Function App and all code
- Cosmos DB account (and all data)
- Storage account
- Application Insights data

## Troubleshooting

### Function Not Working

1. Check Application Insights for errors
2. Verify function code is deployed correctly
3. Check COSMOS_DB_CONNECTION_STRING in app settings
4. Review Function App configuration

### Cosmos DB Connection Errors

1. Verify Cosmos DB account is running
2. Check connection string in Function App settings
3. Verify network access (firewall rules)
4. Check Managed Identity permissions

### Storage Account Issues

1. Ensure storage account name is globally unique (3-24 lowercase alphanumeric)
2. Verify storage account is in same region as Function App
3. Check storage account connection string

## Support

For issues with this Terraform configuration, contact your SpecWeave administrator or file an issue at https://github.com/anton-abyzov/specweave/issues.

## Additional Resources

- [Azure Functions Documentation](https://docs.microsoft.com/en-us/azure/azure-functions/)
- [Cosmos DB Developer Guide](https://docs.microsoft.com/en-us/azure/cosmos-db/)
- [Application Insights Documentation](https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview)
- [Terraform AzureRM Provider](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs)
