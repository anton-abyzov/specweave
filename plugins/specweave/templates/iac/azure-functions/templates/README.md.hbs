# Azure Functions + Cosmos DB Terraform Configuration

**Generated by SpecWeave Serverless Architecture Intelligence**

This Terraform configuration deploys:
- Azure Function App ({{runtime}} {{runtimeVersion}} on {{osType}})
- Azure Cosmos DB (SQL API)
- Azure Storage Account (required for Function App)
- App Service Plan ({{skuName}} SKU)
{{#if enableApplicationInsights}}- Application Insights for monitoring{{/if}}
{{#if enableKeyVault}}- Azure Key Vault for secrets management{{/if}}

## Architecture

```
Azure Function App ({{functionName}})
    ├── Runtime: {{runtime}} {{runtimeVersion}}
    ├── Plan: {{skuName}} ({{#if (eq skuName "Y1")}}Consumption{{else}}Premium{{/if}})
    └── Storage: {{functionName}}storage

Cosmos DB ({{databaseAccountName}})
    ├── Database: {{databaseName}}
    ├── Container: {{containerName}}
    ├── Partition Key: {{partitionKey}}
    └── Throughput: {{throughput}} RU/s

{{#if enableApplicationInsights}}
Application Insights ({{functionName}}-insights)
    └── Type: web
{{/if}}

{{#if enableKeyVault}}
Key Vault ({{functionName}}-kv)
    └── Secrets: Managed by Function App identity
{{/if}}
```

## Prerequisites

1. **Azure CLI** installed and authenticated:
   ```bash
   az login
   az account set --subscription "YOUR_SUBSCRIPTION_ID"
   ```

2. **Terraform** v1.5.0+ installed:
   ```bash
   terraform version
   ```

3. **Function App code** ready to deploy:
   - Node.js: `package.json`, `index.js`, etc.
   - Python: `requirements.txt`, `__init__.py`, etc.

## Deployment Instructions

### 1. Initialize Terraform

```bash
terraform init
```

### 2. Review the Plan

```bash
terraform plan
```

**Expected resources**: ~{{#if enableKeyVault}}10{{else if enableApplicationInsights}}8{{else}}6{{/if}} resources will be created

### 3. Deploy Infrastructure

**Development**:
```bash
terraform apply -var-file="environments/dev.tfvars"
```

**Staging**:
```bash
terraform apply -var-file="environments/staging.tfvars"
```

**Production**:
```bash
terraform apply -var-file="environments/prod.tfvars"
```

### 4. Deploy Function Code

After infrastructure is deployed, deploy your function code:

```bash
# Zip your function code
cd ../src  # Navigate to your function source code
zip -r function.zip .

# Deploy using Azure CLI
az functionapp deployment source config-zip \
  --resource-group {{resourceGroupName}} \
  --name {{functionName}} \
  --src function.zip
```

### 5. Test Your Function

```bash
# Get function URL
FUNCTION_URL=$(terraform output -raw function_app_url)

# Test HTTP trigger (example)
curl "${FUNCTION_URL}/api/hello?name=World"
```

## Cost Estimation

### Development Environment

**Azure Function App (Consumption Plan)**:
- Execution: 1M requests/month = Free (2M free tier)
- Execution time: 100,000 GB-s/month = Free (400,000 GB-s free tier)
- **Total**: $0/month (within free tier)

**Cosmos DB**:
- Throughput: {{throughput}} RU/s × $0.008/hour = ${{multiply throughput 0.008 720}}/month
- Storage: 1 GB = Free (25 GB free tier)
- **Total**: ~${{multiply throughput 0.008 720}}/month

**Storage Account**:
- LRS storage: 1 GB = ~$0.02/month
- Transactions: Minimal cost
- **Total**: ~$0.50/month

**Application Insights**:
- First 5 GB = Free
- **Total**: $0/month (within free tier)

**Total Monthly Cost (Dev)**: ~${{add (multiply throughput 0.008 720) 0.5}}/month

{{#if (eq environment "prod")}}
### Production Environment (Estimated)

**Note**: Production costs depend on actual usage. Estimate above assumes:
- 10M requests/month
- {{throughput}} RU/s Cosmos DB throughput
- ~10 GB storage

For accurate production estimates, use [Azure Pricing Calculator](https://azure.microsoft.com/pricing/calculator/).
{{/if}}

## Free Tier Optimization Tips

1. **Function App**:
   - Use Consumption Plan (Y1) for variable workloads
   - Stay under 1M executions/month for free tier
   - Optimize memory allocation (lower = cheaper)

2. **Cosmos DB**:
   - Start with 400 RU/s (minimum)
   - Use autoscale for variable workloads
   - Monitor RU consumption in Azure Portal

3. **Application Insights**:
   - First 5 GB/month is free
   - Use sampling to reduce data volume
   - Set retention to 90 days

4. **Storage Account**:
   - Use LRS (cheapest replication)
   - Clean up old blobs and logs
   - Enable lifecycle management

## Monitoring

{{#if enableApplicationInsights}}
**Application Insights** is enabled. View metrics at:
```
https://portal.azure.com/#@/resource${terraform output -raw application_insights_id}/overview
```

Key metrics to monitor:
- Request rate and response times
- Failed requests
- Cosmos DB RU consumption
- Function execution count and duration
{{else}}
**Application Insights** is not enabled. To enable monitoring:
1. Set `enableApplicationInsights = true` in `defaults.json`
2. Re-apply Terraform configuration
{{/if}}

## Security Best Practices

1. **Managed Identity**: Function App uses System-Assigned Managed Identity
   - No credentials in code
   - Automatic rotation
   - Azure RBAC for access control

2. **Secrets Management**:
{{#if enableKeyVault}}
   - ✅ Key Vault enabled for secrets
   - Store connection strings in Key Vault
   - Reference via `@Microsoft.KeyVault(SecretUri=...)`
{{else}}
   - ⚠️ Key Vault not enabled
   - Enable with `enableKeyVault = true`
{{/if}}

3. **HTTPS Only**: Function App enforces HTTPS
4. **CORS**: Configured for origins: {{corsOrigins}}
5. **Network Security**:
{{#if enableVnet}}
   - ✅ VNet integration enabled
{{else}}
   - ⚠️ VNet integration not enabled (public access)
   - Enable with `enableVnet = true`
{{/if}}

## Cleanup

To destroy all resources:

```bash
terraform destroy
```

**Warning**: This will permanently delete:
- Function App and all deployed code
- Cosmos DB and all data
- Storage Account and all blobs
- Application Insights telemetry data

## Troubleshooting

### "Resource name already exists"
- Azure resource names must be globally unique
- Modify `appName` in `defaults.json` or `*.tfvars`

### "Insufficient permissions"
- Ensure you have Owner/Contributor role on subscription
- Run `az account show` to verify correct subscription

### "Cosmos DB throughput too low"
- Minimum throughput is 400 RU/s
- Adjust `throughput` in `defaults.json` or `*.tfvars`

### "Function App not responding"
- Check Application Insights for errors
- Verify function code is deployed (`az functionapp deployment list-publishing-credentials`)
- Check CORS settings if calling from browser

## Next Steps

1. **Deploy your function code** (see step 4 above)
2. **Set up CI/CD** with Azure DevOps or GitHub Actions
3. **Configure custom domains** for production
4. **Set up monitoring alerts** in Application Insights
5. **Enable backup** for Cosmos DB (set `enableBackup = true`)

## Support

- **Azure Documentation**: https://docs.microsoft.com/azure/azure-functions/
- **Terraform Azure Provider**: https://registry.terraform.io/providers/hashicorp/azurerm/
- **SpecWeave**: https://spec-weave.com

---

**Generated**: {{currentDate}}
**SpecWeave Version**: {{specweaveVersion}}
