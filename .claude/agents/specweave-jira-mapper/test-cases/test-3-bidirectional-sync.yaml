---
name: "Bidirectional Sync with Conflict Resolution"
description: "Tests if specweave-jira-mapper can sync changes bidirectionally between SpecWeave and JIRA, detecting and resolving conflicts"
input:
  prompt: "Sync increment 0001 with JIRA"

  initial_state:
    specweave:
      file: ".specweave/increments/0001-user-authentication/spec.md"
      frontmatter:
        increment_id: "0001"
        title: "User Authentication"
        status: "in-progress"
        priority: "P1"
        jira:
          epic_key: "AUTH-001"
          epic_url: "https://jira.example.com/browse/AUTH-001"
          stories:
            - key: "AUTH-002"
              user_story_id: "US1-001"
          last_sync: "2025-10-26T10:00:00Z"
          sync_direction: "export"

      tasks_file: ".specweave/increments/0001-user-authentication/tasks.md"
      content: |
        # Tasks: User Authentication

        ## User Story: US1-001

        - [x] Create login API endpoint (JIRA: AUTH-003)
        - [ ] Implement password validation (JIRA: AUTH-004)
        - [ ] Create login UI (JIRA: AUTH-005)

    jira_epic:
      key: "AUTH-001"
      title: "User Auth with OAuth"  # Changed in JIRA
      status: "In Progress"
      last_updated: "2025-10-26T11:00:00Z"
      comments:
        - author: "john.doe"
          created: "2025-10-26T11:15:00Z"
          text: "OAuth integration is now priority"

    jira_subtasks:
      - key: "AUTH-003"
        title: "Create login API endpoint"
        status: "To Do"  # Not updated in JIRA yet
        parent: "AUTH-002"

  changes_since_last_sync:
    specweave:
      - file: "spec.md"
        field: "status"
        old_value: "in-progress"
        new_value: "completed"
        modified_at: "2025-10-26T12:00:00Z"

      - file: "tasks.md"
        field: "task_checkbox"
        task: "Create login API endpoint"
        old_value: "[ ]"
        new_value: "[x]"
        modified_at: "2025-10-26T11:30:00Z"

    jira:
      - epic_key: "AUTH-001"
        field: "title"
        old_value: "User Authentication"
        new_value: "User Auth with OAuth"
        modified_at: "2025-10-26T11:00:00Z"

      - epic_key: "AUTH-001"
        field: "comment_added"
        comment: "OAuth integration is now priority"
        modified_at: "2025-10-26T11:15:00Z"

  conflicts:
    - type: "title_changed_both"
      specweave_value: "User Authentication"
      jira_value: "User Auth with OAuth"
      resolution_required: true

expected_output:
  type: "sync_completed"

  conflict_detection:
    conflicts_found: 1
    conflict_details:
      - type: "title_changed_both"
        description: "Epic title changed in JIRA but SpecWeave title unchanged"
        specweave_value: "User Authentication"
        jira_value: "User Auth with OAuth"
        resolution_options:
          - "Keep SpecWeave title"
          - "Keep JIRA title"
          - "Manual merge"

  user_interaction:
    prompt: |
      ⚠️  Sync Conflicts Detected:

      1. Title changed in JIRA:
         SpecWeave: "User Authentication"
         JIRA: "User Auth with OAuth"

         Choose: [SpecWeave] [JIRA] [Manual]
    user_selection: "JIRA"  # User chooses JIRA title

  changes_applied:
    specweave_to_jira:
      - target: "Subtask AUTH-003"
        field: "status"
        old_value: "To Do"
        new_value: "Done"
        reason: "Task marked complete in SpecWeave tasks.md"

      - target: "Epic AUTH-001"
        field: "status"
        old_value: "In Progress"
        new_value: "Done"
        reason: "Increment status changed to completed in SpecWeave"

    jira_to_specweave:
      - target: "spec.md frontmatter"
        field: "title"
        old_value: "User Authentication"
        new_value: "User Auth with OAuth"
        reason: "User selected JIRA title (conflict resolution)"

      - target: ".specweave/increments/0001-user-authentication/logs/jira-sync.log"
        action: "append"
        content: |
          [2025-10-26T14:30:00Z] JIRA Comment by john.doe:
          "OAuth integration is now priority"

  updated_frontmatter:
    file: ".specweave/increments/0001-user-authentication/spec.md"
    frontmatter:
      title: "User Auth with OAuth"  # Updated from JIRA
      status: "completed"
      jira:
        epic_key: "AUTH-001"
        last_sync: "2025-10-26T14:30:00Z"
        sync_direction: "bidirectional"
        conflicts_resolved: 1

  summary_message: |
    ✅ Synced with JIRA!

    Direction: Bidirectional
    Changes Applied:
      - SpecWeave → JIRA: 2 updates
        • Subtask AUTH-003: To Do → Done
        • Epic AUTH-001: In Progress → Done
      - JIRA → SpecWeave: 2 updates
        • Title: "User Authentication" → "User Auth with OAuth"
        • Added JIRA comment to logs
    Conflicts Resolved: 1 (user decision: Keep JIRA title)
    Last Sync: 2025-10-26T14:30:00Z

validation:
  - "Changes detected since last_sync timestamp"
  - "Conflicts identified correctly (title changed in JIRA)"
  - "User prompted for conflict resolution"
  - "User selection applied (JIRA title kept)"
  - "Task status synced (checkbox → JIRA Subtask status)"
  - "Epic status synced (SpecWeave → JIRA)"
  - "JIRA comments logged to increment logs/"
  - "Sync timestamps updated"
  - "Conflicts count recorded"
  - "Summary message accurate and detailed"

success_criteria:
  - "No data loss (all changes preserved)"
  - "Conflicts resolved explicitly (user decision)"
  - "Bidirectional sync successful"
  - "Traceability maintained (sync log)"
  - "Both systems consistent after sync"

edge_cases:
  multiple_conflicts:
    conflicts:
      - type: "title_changed_both"
      - type: "status_mismatch"
      - type: "priority_changed_both"
    expected: "User prompted for each conflict separately"

  auto_resolvable:
    - scenario: "Task marked done in SpecWeave, JIRA Subtask still In Progress"
      resolution: "Update JIRA Subtask to Done (no conflict)"

    - scenario: "JIRA comment added"
      resolution: "Add to SpecWeave logs (no conflict)"

  non_resolvable:
    - scenario: "Epic deleted in JIRA"
      resolution: "Error message, cannot sync deleted Epic"

  api_errors:
    - scenario: "JIRA API rate limit during sync"
      resolution: "Retry with exponential backoff"

    - scenario: "Network timeout"
      resolution: "Rollback partial changes, report error"

conflict_resolution_matrix:
  title_changed_both:
    options: ["SpecWeave", "JIRA", "Manual"]
    default: null  # Must ask user

  status_mismatch:
    options: ["SpecWeave", "JIRA", "Manual"]
    default: null  # Must ask user

  priority_changed_both:
    options: ["SpecWeave", "JIRA", "Manual"]
    default: null  # Must ask user

  task_done_specweave_only:
    options: ["Update JIRA"]
    default: "Update JIRA"  # Auto-resolve

  comment_added_jira:
    options: ["Add to SpecWeave logs"]
    default: "Add to SpecWeave logs"  # Auto-resolve

logging:
  sync_log_file: ".specweave/increments/0001-user-authentication/logs/jira-sync.log"
  log_entries:
    - "[2025-10-26T14:30:00Z] INFO: Starting bidirectional sync"
    - "[2025-10-26T14:30:01Z] INFO: Detected 2 SpecWeave changes"
    - "[2025-10-26T14:30:02Z] INFO: Detected 2 JIRA changes"
    - "[2025-10-26T14:30:03Z] WARN: Conflict detected - title changed in JIRA"
    - "[2025-10-26T14:30:10Z] INFO: User resolved conflict - Keep JIRA title"
    - "[2025-10-26T14:30:15Z] INFO: Applied 2 SpecWeave → JIRA updates"
    - "[2025-10-26T14:30:20Z] INFO: Applied 2 JIRA → SpecWeave updates"
    - "[2025-10-26T14:30:25Z] SUCCESS: Sync completed"
    - "[2025-10-26T14:30:25Z] JIRA Comment by john.doe: OAuth integration is now priority"
---
