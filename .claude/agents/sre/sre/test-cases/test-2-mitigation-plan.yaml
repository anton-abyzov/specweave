---
name: "Mitigation Plan Creation - Service Down"
description: "Tests if SRE agent can create comprehensive mitigation plan for service outage"
priority: "P1"
expected_duration: "3-5 minutes"

input:
  prompt: "Application is down, users getting 502 Bad Gateway errors"
  context:
    - "Service: payment-service"
    - "Error: 502 Bad Gateway"
    - "Users affected: All users (100%)"
    - "Duration: Started 5 minutes ago"
    - "Last deployment: 2 hours ago"
    - "Logs show: OutOfMemoryError"

expected_output:
  type: "mitigation_plan"
  format: "structured"

  # Required sections
  required_sections:
    - "executive_summary"
    - "immediate_actions"
    - "short_term_actions"
    - "long_term_actions"
    - "risk_assessment"
    - "validation"

  # Executive summary
  executive_summary:
    problem: "Payment service crashed due to OutOfMemoryError"
    impact: "All users unable to process payments"
    solution: "Restart service + increase memory + fix memory leak"
    eta: "< 30 minutes"

  # Immediate actions (0-5 min)
  immediate_actions:
    goal: "Restore service"
    actions:
      - what: "Restart payment service with increased memory"
        how: "systemctl restart payment-service"
        impact: "Service restored"
        risk: "Low"
        eta: "2 minutes"
        owner: "SRE"

  # Short-term actions (5 min - 1 hour)
  short_term_actions:
    goal: "Prevent immediate recurrence"
    actions:
      - what: "Analyze heap dump"
        how: "jmap -dump or heap snapshot"
        eta: "20 minutes"

      - what: "Identify memory leak"
        how: "Review heap dump for growing objects"
        eta: "30 minutes"

  # Long-term actions (1 hour+)
  long_term_actions:
    goal: "Permanent fix and prevention"
    actions:
      - what: "Fix memory leak in code"
        priority: "P1"
        owner: "Developer"

      - what: "Add memory monitoring alert"
        priority: "P2"
        owner: "SRE"

      - what: "Add memory regression test"
        priority: "P3"
        owner: "QA"

  # Risk assessment
  risk_assessment:
    mitigation_risks:
      - action: "Restart service"
        risk_level: "Low"
        risk_description: "Brief downtime during restart"
        mitigation: "Graceful restart, off-peak time"

      - action: "Increase memory"
        risk_level: "Low"
        risk_description: "More memory usage"
        mitigation: "Server has capacity"

    risks_of_not_mitigating:
      - risk: "Service remains down"
        impact: "100% of users affected"
        probability: "High"

# Validation criteria
validation:
  - "Mitigation plan has 3 time horizons (immediate/short/long)"
  - "Each action has: what, how, impact, risk, eta"
  - "Immediate actions restore service quickly (<5 min)"
  - "Short-term actions prevent immediate recurrence"
  - "Long-term actions provide permanent fix"
  - "Risk assessment included"
  - "Owners assigned for each action"

# Success criteria
success_criteria:
  - "Immediate action is to restart service (correct)"
  - "Memory leak identified as root cause"
  - "Heap dump analysis mentioned"
  - "Memory monitoring added to prevent recurrence"
  - "All actions have time estimates"
  - "Risk level assessed for each action"
  - "Rollback plan included (optional but good)"

# Failure indicators
failure_indicators:
  - "Only suggests immediate fix (no short/long term)"
  - "No risk assessment"
  - "No time estimates"
  - "No owner assignment"
  - "Suggests scaling up without fixing leak"
  - "No verification/validation steps"

# Related playbooks
related_playbooks:
  - "playbooks/07-service-down.md"
  - "playbooks/03-memory-leak.md"

# Notes
notes: |
  This test validates the SRE agent's ability to:
  1. Create comprehensive 3-horizon mitigation plan
  2. Balance immediate restoration with permanent fixes
  3. Assess risks for each action
  4. Provide specific, actionable steps
  5. Assign owners and deadlines

  The agent should recognize that:
  - Immediate: Restart service (restore service)
  - Short-term: Analyze heap dump (identify leak)
  - Long-term: Fix code (permanent solution)

  NOT just restart and hope for the best!
